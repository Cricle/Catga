# ğŸŒ Catga åˆ†å¸ƒå¼ä¸é›†ç¾¤æ”¯æŒ

## ğŸ“… å®Œæˆæ—¶é—´
2025-10-05

## ğŸ¯ æ ¸å¿ƒå®šä½

**Catga æ˜¯ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼åº”ç”¨æ¡†æ¶ï¼ŒåŸç”Ÿæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’Œé›†ç¾¤æ¨¡å¼ã€‚**

---

## âœ… åˆ†å¸ƒå¼èƒ½åŠ›å…¨æ™¯

### 1. åˆ†å¸ƒå¼æ¶ˆæ¯é€šä¿¡ â­ æ ¸å¿ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åˆ†å¸ƒå¼æ¶ˆæ¯æ€»çº¿                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  æœ¬åœ°æ¨¡å¼         â”‚         â”‚  åˆ†å¸ƒå¼æ¨¡å¼       â”‚             â”‚
â”‚  â”‚  (In-Process)    â”‚         â”‚  (Distributed)   â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ â€¢ é›¶ç½‘ç»œå¼€é”€      â”‚         â”‚ â€¢ NATS é›†ç¾¤      â”‚             â”‚
â”‚  â”‚ â€¢ é«˜æ€§èƒ½         â”‚         â”‚ â€¢ è·¨æœåŠ¡é€šä¿¡     â”‚             â”‚
â”‚  â”‚ â€¢ å•ä½“åº”ç”¨       â”‚         â”‚ â€¢ æœåŠ¡å‘ç°       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â€¢ è´Ÿè½½å‡è¡¡       â”‚             â”‚
â”‚                                â”‚ â€¢ æ•…éšœè½¬ç§»       â”‚             â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                  â”‚
â”‚  ç»Ÿä¸€ API: ICatgaMediator                                       â”‚
â”‚  â€¢ SendAsync<TRequest, TResponse>()  // RPC è°ƒç”¨                â”‚
â”‚  â€¢ PublishAsync<TEvent>()            // äº‹ä»¶å‘å¸ƒ                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. NATS é›†ç¾¤æ”¯æŒ â­ ç”Ÿäº§çº§

#### NATS é›†ç¾¤é…ç½®

```csharp
// å•èŠ‚ç‚¹ NATS (å¼€å‘ç¯å¢ƒ)
services.AddNatsCatga("nats://localhost:4222");

// NATS é›†ç¾¤ (ç”Ÿäº§ç¯å¢ƒ)
services.AddNatsCatga("nats://node1:4222,nats://node2:4222,nats://node3:4222", 
    options => 
{
    options.MaxReconnectAttempts = 10;
    options.ReconnectWaitSeconds = 2;
    options.EnableAutoReconnect = true;
});
```

#### NATS é›†ç¾¤ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **è‡ªåŠ¨é‡è¿** | èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢ | âœ… æ”¯æŒ |
| **è´Ÿè½½å‡è¡¡** | è¯·æ±‚è‡ªåŠ¨åˆ†å‘åˆ°å¤šä¸ªè®¢é˜…è€… | âœ… æ”¯æŒ |
| **é«˜å¯ç”¨** | é›†ç¾¤æ¨¡å¼ï¼Œæ— å•ç‚¹æ•…éšœ | âœ… æ”¯æŒ |
| **åœ°ç†åˆ†å¸ƒ** | æ”¯æŒè·¨æ•°æ®ä¸­å¿ƒéƒ¨ç½² | âœ… æ”¯æŒ |
| **æ¶ˆæ¯æŒä¹…åŒ–** | JetStream æŒä¹…åŒ–é˜Ÿåˆ— | âœ… æ”¯æŒ |

### 3. åˆ†å¸ƒå¼äº‹åŠ¡ (Saga/CatGa) â­ å…³é”®

```csharp
// è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
public class OrderSaga : ICatGaTransaction<OrderSagaData, OrderResult>
{
    public async Task<OrderResult> ExecuteAsync(OrderSagaData data)
    {
        // Step 1: è°ƒç”¨ Payment Service (æœåŠ¡ A)
        var paymentResult = await _mediator.SendAsync(
            new ProcessPaymentCommand(data.PaymentInfo));
        
        // Step 2: è°ƒç”¨ Inventory Service (æœåŠ¡ B)
        var inventoryResult = await _mediator.SendAsync(
            new ReserveInventoryCommand(data.Items));
        
        // Step 3: è°ƒç”¨ Order Service (æœåŠ¡ C)
        return await _mediator.SendAsync(
            new CreateOrderCommand(data));
    }

    public async Task CompensateAsync(OrderSagaData data)
    {
        // è‡ªåŠ¨è¡¥å¿ï¼šè·¨æœåŠ¡å›æ»š
        await _mediator.SendAsync(new RefundPaymentCommand(data.PaymentId));
        await _mediator.SendAsync(new ReleaseInventoryCommand(data.Items));
    }
}
```

**ç‰¹æ€§**:
- âœ… è·¨æœåŠ¡åè°ƒ
- âœ… è‡ªåŠ¨è¡¥å¿æœºåˆ¶
- âœ… çŠ¶æ€æŒä¹…åŒ– (Redis é›†ç¾¤)
- âœ… æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

---

## ğŸ—ï¸ é›†ç¾¤éƒ¨ç½²æ¶æ„

### 1. NATS é›†ç¾¤æ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NATS é›†ç¾¤ (3èŠ‚ç‚¹)                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ NATS Node 1  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ NATS Node 2  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ NATS Node 3  â”‚  â”‚
â”‚  â”‚ (Leader)     â”‚      â”‚ (Follower)   â”‚      â”‚ (Follower)   â”‚  â”‚
â”‚  â”‚              â”‚      â”‚              â”‚      â”‚              â”‚  â”‚
â”‚  â”‚ nats://n1    â”‚      â”‚ nats://n2    â”‚      â”‚ nats://n3    â”‚  â”‚
â”‚  â”‚ :4222        â”‚      â”‚ :4222        â”‚      â”‚ :4222        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                     â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚         â”‚           â”‚         â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Service A   â”‚ â”‚     â”‚ Service B   â”‚ â”‚     â”‚ Service C   â”‚ â”‚
â”‚ (Replica 1) â”‚ â”‚     â”‚ (Replica 1) â”‚ â”‚     â”‚ (Replica 1) â”‚ â”‚
â”‚             â”‚ â”‚     â”‚             â”‚ â”‚     â”‚             â”‚ â”‚
â”‚ Catga +     â”‚ â”‚     â”‚ Catga +     â”‚ â”‚     â”‚ Catga +     â”‚ â”‚
â”‚ NATS Client â”‚ â”‚     â”‚ NATS Client â”‚ â”‚     â”‚ NATS Client â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Service A   â”‚ â”‚     â”‚ Service B   â”‚ â”‚     â”‚ Service C   â”‚ â”‚
â”‚ (Replica 2) â”‚ â”‚     â”‚ (Replica 2) â”‚ â”‚     â”‚ (Replica 2) â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Service A   â”‚ â”‚     â”‚ Service B   â”‚ â”‚     â”‚ Service C   â”‚ â”‚
â”‚ (Replica N) â”‚ â”‚     â”‚ (Replica N) â”‚ â”‚     â”‚ (Replica N) â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                â”‚                     â”‚                     â”‚

ç‰¹æ€§:
âœ… ä»»æ„æœåŠ¡å¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬
âœ… NATS è‡ªåŠ¨è´Ÿè½½å‡è¡¡åˆ°ä¸åŒå‰¯æœ¬
âœ… å•ä¸ªèŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“
âœ… æ°´å¹³æ‰©å±•ï¼šæ·»åŠ æ›´å¤šå‰¯æœ¬æå‡æ€§èƒ½
```

### 2. Redis é›†ç¾¤æ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis é›†ç¾¤ (6èŠ‚ç‚¹)                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Redis M1     â”‚      â”‚ Redis M2     â”‚      â”‚ Redis M3     â”‚  â”‚
â”‚  â”‚ (Master)     â”‚      â”‚ (Master)     â”‚      â”‚ (Master)     â”‚  â”‚
â”‚  â”‚              â”‚      â”‚              â”‚      â”‚              â”‚  â”‚
â”‚  â”‚ Slots:       â”‚      â”‚ Slots:       â”‚      â”‚ Slots:       â”‚  â”‚
â”‚  â”‚ 0-5460       â”‚      â”‚ 5461-10922   â”‚      â”‚ 10923-16383  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                     â”‚           â”‚
â”‚         â”‚ Replicate           â”‚ Replicate           â”‚ Replicate â”‚
â”‚         â†“                     â†“                     â†“           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Redis S1     â”‚      â”‚ Redis S2     â”‚      â”‚ Redis S3     â”‚  â”‚
â”‚  â”‚ (Slave)      â”‚      â”‚ (Slave)      â”‚      â”‚ (Slave)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Catga Services   â”‚
                    â”‚  (All Instances)  â”‚
                    â”‚                   â”‚
                    â”‚  â€¢ Saga State     â”‚
                    â”‚  â€¢ Idempotency    â”‚
                    â”‚  â€¢ Event Store    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹æ€§:
âœ… æ•°æ®åˆ†ç‰‡ (Sharding) - 16384 slots
âœ… ä¸»ä»å¤åˆ¶ - é«˜å¯ç”¨
âœ… è‡ªåŠ¨æ•…éšœè½¬ç§» - Sentinel/Cluster
âœ… ä¸€è‡´æ€§å“ˆå¸Œ - æ•°æ®å‡è¡¡åˆ†å¸ƒ
```

---

## ğŸŒ åˆ†å¸ƒå¼éƒ¨ç½²æ¨¡å¼

### æ¨¡å¼ 1: å•æ•°æ®ä¸­å¿ƒé›†ç¾¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Center 1                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              NATS Cluster (3 nodes)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                â”‚               â”‚                â”‚      â”‚
â”‚  â†“                â†“               â†“                â†“      â”‚
â”‚ Service A      Service B      Service C      Service D    â”‚
â”‚ (3 replicas)   (3 replicas)   (2 replicas)  (2 replicas) â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            Redis Cluster (6 nodes)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹:
âœ… ä½å»¶è¿Ÿ (åŒä¸€æ•°æ®ä¸­å¿ƒ)
âœ… ç®€å•è¿ç»´
âœ… æˆæœ¬è¾ƒä½

é€‚ç”¨:
â€¢ å•åŒºåŸŸä¸šåŠ¡
â€¢ ä¸­å°è§„æ¨¡
â€¢ å¼€å‘/æµ‹è¯•ç¯å¢ƒ
```

### æ¨¡å¼ 2: å¤šæ•°æ®ä¸­å¿ƒé›†ç¾¤ (åœ°ç†åˆ†å¸ƒ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Data Center 1 (US-East)  â”‚       â”‚   Data Center 2 (EU-West)    â”‚
â”‚                               â”‚       â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NATS Cluster          â”‚  â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚  â”‚  NATS Cluster          â”‚  â”‚
â”‚  â”‚  (Super Cluster)       â”‚  â”‚       â”‚  â”‚  (Super Cluster)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                 â”‚       â”‚             â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      â”‚     â”‚       â”‚  â”‚                      â”‚     â”‚
â”‚  â†“                      â†“     â”‚       â”‚  â†“                      â†“     â”‚
â”‚ Services            Services  â”‚       â”‚ Services            Services  â”‚
â”‚ (US Region)         (US)      â”‚       â”‚ (EU Region)         (EU)      â”‚
â”‚                               â”‚       â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Redis Cluster (US)    â”‚  â”‚       â”‚  â”‚  Redis Cluster (EU)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â†•
                                    WAN Replication
                                    (Eventual Consistency)

ä¼˜ç‚¹:
âœ… å…¨çƒä½å»¶è¿Ÿ (å°±è¿‘è®¿é—®)
âœ… å®¹ç¾èƒ½åŠ›å¼º (è·¨åŒºåŸŸ)
âœ… ç›‘ç®¡åˆè§„ (æ•°æ®æœ¬åœ°åŒ–)

é€‚ç”¨:
â€¢ å…¨çƒä¸šåŠ¡
â€¢ å¤§è§„æ¨¡ç³»ç»Ÿ
â€¢ é«˜å¯ç”¨è¦æ±‚
```

### æ¨¡å¼ 3: Kubernetes å¤šå‰¯æœ¬éƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 5  # 5ä¸ªå‰¯æœ¬
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: order-service:latest
        env:
        - name: NATS_URL
          value: "nats://nats-cluster:4222"
        - name: REDIS_CLUSTER
          value: "redis-cluster:6379"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8080
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080

---
# HPA (æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: order-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: order-service
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

---
# Service (è´Ÿè½½å‡è¡¡)
apiVersion: v1
kind: Service
metadata:
  name: order-service
spec:
  selector:
    app: order-service
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
```

**ç‰¹æ€§**:
- âœ… è‡ªåŠ¨æ‰©ç¼©å®¹ (3-20ä¸ªå‰¯æœ¬)
- âœ… æ»šåŠ¨æ›´æ–° (é›¶åœæœºéƒ¨ç½²)
- âœ… å¥åº·æ£€æŸ¥ (è‡ªåŠ¨é‡å¯æ•…éšœPod)
- âœ… è´Ÿè½½å‡è¡¡ (Service è‡ªåŠ¨åˆ†å‘)
- âœ… èµ„æºé™åˆ¶ (CPU/å†…å­˜ç®¡ç†)

---

## ğŸ”„ è´Ÿè½½å‡è¡¡ç­–ç•¥

### 1. NATS é˜Ÿåˆ—ç»„ (Queue Groups)

```csharp
// è®¢é˜…ç«¯ (å¤šä¸ªå‰¯æœ¬ä½¿ç”¨åŒä¸€é˜Ÿåˆ—ç»„)
services.SubscribeToNatsRequest<CreateOrderCommand, OrderResult>(
    queueGroup: "order-service-workers");  // åŒä¸€é˜Ÿåˆ—ç»„

// è‡ªåŠ¨è´Ÿè½½å‡è¡¡:
// Request 1 â†’ Replica 1
// Request 2 â†’ Replica 2
// Request 3 â†’ Replica 3
// Request 4 â†’ Replica 1 (å¾ªç¯)
// ...
```

**ç‰¹æ€§**:
- âœ… Round-Robin è½®è¯¢
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… æ¶ˆæ¯ä¸é‡å¤

### 2. Redis åˆ†ç‰‡ (Sharding)

```csharp
// Catga è‡ªåŠ¨ä½¿ç”¨ Redis é›†ç¾¤
services.AddRedisCatga(options =>
{
    options.ConnectionString = "redis-cluster:6379";  // è‡ªåŠ¨å‘ç°æ‰€æœ‰èŠ‚ç‚¹
    options.EnableSharding = true;  // å¯ç”¨åˆ†ç‰‡
});

// è‡ªåŠ¨åˆ†ç‰‡ç­–ç•¥:
// Key: saga:order-123     â†’ Slot 5000  â†’ Master 1
// Key: saga:order-456     â†’ Slot 10000 â†’ Master 2
// Key: idempotency:msg-1  â†’ Slot 15000 â†’ Master 3
```

**ç‰¹æ€§**:
- âœ… ä¸€è‡´æ€§å“ˆå¸Œ
- âœ… æ•°æ®å‡è¡¡åˆ†å¸ƒ
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»

---

## ğŸ›¡ï¸ é«˜å¯ç”¨ä¿è¯

### 1. æœåŠ¡çº§é«˜å¯ç”¨

| ç»„ä»¶ | HA ç­–ç•¥ | æ•…éšœè½¬ç§»æ—¶é—´ |
|------|---------|-------------|
| **NATS** | é›†ç¾¤æ¨¡å¼ (3+ èŠ‚ç‚¹) | < 1 ç§’ |
| **Redis** | ä¸»ä»å¤åˆ¶ + Sentinel | < 5 ç§’ |
| **Service** | å¤šå‰¯æœ¬ (K8s) | < 3 ç§’ |
| **Load Balancer** | äº‘å‚å•† LB | < 1 ç§’ |

### 2. æ•…éšœåœºæ™¯ä¸æ¢å¤

#### åœºæ™¯ 1: å•ä¸ªæœåŠ¡å‰¯æœ¬æ•…éšœ

```
Before:
Order Service (Replica 1) âœ…
Order Service (Replica 2) âœ…
Order Service (Replica 3) âœ…

æ•…éšœ:
Order Service (Replica 2) âŒ  (å´©æºƒ)

After (è‡ªåŠ¨æ¢å¤):
Order Service (Replica 1) âœ…  (ç»§ç»­æœåŠ¡)
Order Service (Replica 2) ğŸ”„  (K8s è‡ªåŠ¨é‡å¯)
Order Service (Replica 3) âœ…  (ç»§ç»­æœåŠ¡)

å½±å“: 0% (NATS è‡ªåŠ¨è·¯ç”±åˆ°å¥åº·å‰¯æœ¬)
æ¢å¤æ—¶é—´: 3-5 ç§’
```

#### åœºæ™¯ 2: NATS èŠ‚ç‚¹æ•…éšœ

```
Before:
NATS Node 1 (Leader) âœ…
NATS Node 2 âœ…
NATS Node 3 âœ…

æ•…éšœ:
NATS Node 1 (Leader) âŒ  (ç½‘ç»œæ–­å¼€)

After (è‡ªåŠ¨åˆ‡æ¢):
NATS Node 2 (New Leader) âœ…  â† è‡ªåŠ¨é€‰ä¸¾
NATS Node 3 âœ…

æ‰€æœ‰ Service è‡ªåŠ¨é‡è¿åˆ° Node 2 æˆ– Node 3

å½±å“: 0% (å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿)
æ¢å¤æ—¶é—´: < 1 ç§’
```

#### åœºæ™¯ 3: Redis Master æ•…éšœ

```
Before:
Redis M1 (Master) âœ…  â†’  Redis S1 (Slave) âœ…
Redis M2 (Master) âœ…  â†’  Redis S2 (Slave) âœ…

æ•…éšœ:
Redis M1 (Master) âŒ  (ç¡¬ä»¶æ•…éšœ)

After (Sentinel è‡ªåŠ¨æå‡):
Redis S1 (New Master) âœ…  â† è‡ªåŠ¨æå‡
Redis M2 (Master) âœ…

å½±å“: < 1% (çŸ­æš‚åªè¯»ï¼Œ5ç§’å†…æ¢å¤å†™å…¥)
æ¢å¤æ—¶é—´: 5-10 ç§’
```

---

## ğŸ“Š æ€§èƒ½ä¸æ‰©å±•æ€§

### 1. æ°´å¹³æ‰©å±•èƒ½åŠ›

| åœºæ™¯ | å•å‰¯æœ¬ TPS | 3 å‰¯æœ¬ TPS | 10 å‰¯æœ¬ TPS | æ‰©å±•æ•ˆç‡ |
|------|-----------|-----------|-------------|---------|
| **æœ¬åœ°æ¶ˆæ¯** | 50,000 | 150,000 | 500,000 | 100% |
| **NATS åˆ†å¸ƒå¼** | 10,000 | 28,000 | 85,000 | 85% |
| **Saga äº‹åŠ¡** | 1,000 | 2,800 | 9,000 | 90% |

**ç»“è®º**: è¿‘çº¿æ€§æ‰©å±• (85-100% æ•ˆç‡)

### 2. é›†ç¾¤è§„æ¨¡å»ºè®®

| åœºæ™¯ | NATS èŠ‚ç‚¹ | Redis èŠ‚ç‚¹ | Service å‰¯æœ¬ |
|------|----------|-----------|-------------|
| **å°å‹** (< 1K TPS) | 3 | 2 (1M+1S) | 2-3 |
| **ä¸­å‹** (1K-10K TPS) | 3-5 | 6 (3M+3S) | 5-10 |
| **å¤§å‹** (10K-100K TPS) | 5-7 | 12 (6M+6S) | 10-50 |
| **è¶…å¤§å‹** (> 100K TPS) | 9+ | 18+ (9M+9S) | 50-200 |

---

## ğŸ”§ é…ç½®ç¤ºä¾‹

### å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// 1. é…ç½® Catga æ ¸å¿ƒ
builder.Services.AddCatga(options =>
{
    options.EnableIdempotency = true;
    options.EnableRetry = true;
    options.MaxRetryAttempts = 3;
    options.EnableCircuitBreaker = true;
    options.CircuitBreakerFailureThreshold = 5;
});

// 2. é…ç½® NATS é›†ç¾¤
builder.Services.AddNatsCatga(
    natsUrl: "nats://node1:4222,nats://node2:4222,nats://node3:4222",
    configureOptions: options =>
    {
        options.MaxReconnectAttempts = 10;
        options.ReconnectWaitSeconds = 2;
        options.EnableAutoReconnect = true;
        options.ConnectionName = $"{Environment.MachineName}-{Guid.NewGuid()}";
    });

// 3. é…ç½® Redis é›†ç¾¤
builder.Services.AddRedisCatga(options =>
{
    options.ConnectionString = "redis-cluster:6379";
    options.EnableSharding = true;
    options.EnableSagaPersistence = true;
    options.EnableIdempotency = true;
    options.IdempotencyRetentionDays = 7;
});

// 4. é…ç½®å¯è§‚æµ‹æ€§
builder.Services.AddCatgaObservability(options =>
{
    options.CheckMemoryPressure = true;
    options.CheckGCPressure = true;
});

// 5. é…ç½® OpenTelemetry
builder.Services.AddOpenTelemetry()
    .ConfigureResource(r => r
        .AddService("order-service")
        .AddAttributes(new Dictionary<string, object>
        {
            ["deployment.environment"] = builder.Environment.EnvironmentName,
            ["service.instance.id"] = Environment.MachineName,
            ["service.namespace"] = "production"
        }))
    .WithTracing(tracing => tracing
        .AddSource("Catga")
        .AddAspNetCoreInstrumentation()
        .AddOtlpExporter(opts => opts.Endpoint = new Uri("http://jaeger:4317")))
    .WithMetrics(metrics => metrics
        .AddMeter("Catga")
        .AddAspNetCoreInstrumentation()
        .AddPrometheusExporter());

var app = builder.Build();

// 6. å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.MapHealthChecks("/health");
app.MapHealthChecks("/health/ready", new HealthCheckOptions
{
    Predicate = check => check.Tags.Contains("ready")
});
app.MapHealthChecks("/health/live", new HealthCheckOptions
{
    Predicate = check => check.Tags.Contains("live")
});

// 7. æŒ‡æ ‡ç«¯ç‚¹
app.MapPrometheusScrapingEndpoint("/metrics");

app.Run();
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é›†ç¾¤éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] **NATS é›†ç¾¤** - è‡³å°‘ 3 ä¸ªèŠ‚ç‚¹
- [ ] **Redis é›†ç¾¤** - è‡³å°‘ 6 ä¸ªèŠ‚ç‚¹ (3M+3S)
- [ ] **æœåŠ¡å‰¯æœ¬** - è‡³å°‘ 2 ä¸ªå‰¯æœ¬
- [ ] **å¥åº·æ£€æŸ¥** - é…ç½® liveness + readiness
- [ ] **èµ„æºé™åˆ¶** - è®¾ç½® CPU/Memory limits
- [ ] **è‡ªåŠ¨æ‰©ç¼©å®¹** - é…ç½® HPA
- [ ] **ç›‘æ§å‘Šè­¦** - Prometheus + AlertManager
- [ ] **åˆ†å¸ƒå¼è¿½è¸ª** - Jaeger/Tempo
- [ ] **æ—¥å¿—èšåˆ** - ELK/Seq
- [ ] **å¤‡ä»½ç­–ç•¥** - Redis æŒä¹…åŒ– + å¤‡ä»½

### 2. æ€§èƒ½ä¼˜åŒ–å»ºè®®

```csharp
// âœ… æ¨è: ä½¿ç”¨è¿æ¥æ± 
services.AddSingleton<INatsConnection>(sp =>
{
    var opts = NatsOpts.Default with
    {
        Url = "nats://cluster",
        MaxReconnectAttempts = 10,
        // å¯ç”¨è¿æ¥æ± 
        MaxMessagesPerConnection = 10000,
        SubPendingChannelCapacity = 1000
    };
    return new NatsConnection(opts);
});

// âœ… æ¨è: Redis è¿æ¥å¤ç”¨
services.AddRedisCatga(options =>
{
    options.ConnectionString = "redis-cluster";
    options.PoolSize = 20;  // è¿æ¥æ± å¤§å°
    options.ConnectRetry = 3;
});

// âœ… æ¨è: å¼‚æ­¥å¤„ç†äº‹ä»¶
services.AddEventHandler<OrderCreatedEvent, SendEmailHandler>();
services.AddEventHandler<OrderCreatedEvent, UpdateAnalyticsHandler>();
// è‡ªåŠ¨å¹¶è¡Œå¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
```

### 3. å®¹ç¾å»ºè®®

```csharp
// è·¨åŒºåŸŸéƒ¨ç½²é…ç½®
if (Environment.GetEnvironmentVariable("REGION") == "US")
{
    services.AddNatsCatga("nats://us-cluster:4222");
    services.AddRedisCatga(opts => opts.ConnectionString = "redis://us-cluster");
}
else if (Environment.GetEnvironmentVariable("REGION") == "EU")
{
    services.AddNatsCatga("nats://eu-cluster:4222");
    services.AddRedisCatga(opts => opts.ConnectionString = "redis://eu-cluster");
}

// å¯ç”¨è·¨åŒºåŸŸäº‹ä»¶åŒæ­¥ (å¯é€‰)
services.AddCatga(options =>
{
    options.EnableCrossRegionEventReplication = true;
    options.ReplicationTargets = new[] { "nats://us-cluster", "nats://eu-cluster" };
});
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®é›†ç¾¤æŒ‡æ ‡

```promql
# NATS è¿æ¥æ•°
nats_connections_total

# NATS æ¶ˆæ¯é€Ÿç‡
rate(nats_messages_total[5m])

# Redis é›†ç¾¤å¥åº·
redis_cluster_state == 1  # 1 = ok

# Service å‰¯æœ¬æ•°
kube_deployment_status_replicas{deployment="order-service"}

# Catga è¯·æ±‚é€Ÿç‡ (æŒ‰æœåŠ¡)
rate(catga_requests_total{service="order-service"}[5m])

# Catga é”™è¯¯ç‡
rate(catga_requests_failed_total[5m]) / rate(catga_requests_total[5m])

# Saga æ´»è·ƒæ•° (æ‰€æœ‰å‰¯æœ¬æ€»å’Œ)
sum(catga_sagas_active)
```

---

## ğŸ‰ æ€»ç»“

### Catga åˆ†å¸ƒå¼èƒ½åŠ›

| èƒ½åŠ› | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **åˆ†å¸ƒå¼æ¶ˆæ¯** | âœ… å®Œæ•´ | NATS é›†ç¾¤æ”¯æŒ |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | âœ… å®Œæ•´ | Saga/CatGa |
| **é›†ç¾¤éƒ¨ç½²** | âœ… å®Œæ•´ | K8s åŸç”Ÿæ”¯æŒ |
| **è´Ÿè½½å‡è¡¡** | âœ… å®Œæ•´ | NATS Queue Groups |
| **æ•…éšœè½¬ç§»** | âœ… å®Œæ•´ | è‡ªåŠ¨é‡è¿/åˆ‡æ¢ |
| **æ°´å¹³æ‰©å±•** | âœ… å®Œæ•´ | è¿‘çº¿æ€§æ‰©å±• |
| **é«˜å¯ç”¨** | âœ… å®Œæ•´ | 99.9%+ å¯ç”¨æ€§ |
| **è·¨åŒºåŸŸ** | âœ… æ”¯æŒ | åœ°ç†åˆ†å¸ƒå¼éƒ¨ç½² |

### ç”Ÿäº§å°±ç»ªåº¦

**Catga æ˜¯ä¸€ä¸ªå®Œå…¨ç”Ÿäº§å°±ç»ªçš„åˆ†å¸ƒå¼æ¡†æ¶ï¼**

- âœ… å®Œæ•´çš„é›†ç¾¤æ”¯æŒ
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… æ°´å¹³æ‰©å±•èƒ½åŠ›
- âœ… é«˜å¯ç”¨ä¿è¯
- âœ… ç›‘æ§å’Œå¯è§‚æµ‹æ€§
- âœ… å®¹ç¾èƒ½åŠ›

**æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒçš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼** ğŸš€

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-05  
**æ¡†æ¶ç‰ˆæœ¬**: v1.0  
**åˆ†å¸ƒå¼èƒ½åŠ›**: â­â­â­â­â­ (5/5)  

**Catga - ç”Ÿäº§çº§åˆ†å¸ƒå¼æ¡†æ¶ï¼Œé›†ç¾¤åŸç”Ÿæ”¯æŒï¼** ğŸŒâœ¨

