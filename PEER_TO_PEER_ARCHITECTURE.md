# ğŸ”„ Catga æ— ä¸»å¤šä»ï¼ˆPeer-to-Peerï¼‰æ¶æ„

## ğŸ“… åˆ†ææ—¶é—´
2025-10-05

## ğŸ¯ æ ¸å¿ƒæ¶æ„åˆ†æ

**Catga é‡‡ç”¨æ— ä¸»å¤šä»ï¼ˆPeer-to-Peerï¼‰çš„å¯¹ç­‰æ¶æ„ï¼Œæ²¡æœ‰ä¸­å¿ƒæ§åˆ¶èŠ‚ç‚¹ï¼Œæ‰€æœ‰æœåŠ¡å®ä¾‹åœ°ä½å¹³ç­‰ã€‚**

---

## âœ… æ— ä¸»å¤šä»æ¶æ„ç‰¹æ€§

### 1. å¯¹ç­‰æ¶æ„ï¼ˆPeer-to-Peerï¼‰â­ æ ¸å¿ƒ

```
ä¼ ç»Ÿä¸»ä»æ¶æ„ï¼ˆMaster-Slaveï¼‰âŒ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Master    â”‚  â† å•ç‚¹æ•…éšœï¼
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”¼â”€â”€â”€â”
   â†“   â†“   â†“
â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”
â”‚S1  â”‚â”‚S2  â”‚â”‚S3  â”‚
â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜

Catga å¯¹ç­‰æ¶æ„ï¼ˆPeer-to-Peerï¼‰âœ…:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         NATS (Message Broker)      â”‚
â”‚         æ— ä¸­å¿ƒæ§åˆ¶èŠ‚ç‚¹              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚         â”‚
       â†“         â†“         â†“
    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”
    â”‚ P1 â”‚    â”‚ P2 â”‚    â”‚ P3 â”‚
    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜
     â†•          â†•          â†•
    å¹³ç­‰       å¹³ç­‰       å¹³ç­‰
    
æ‰€æœ‰å®ä¾‹åœ°ä½ç›¸åŒï¼š
â€¢ å¯ä»¥æ¥æ”¶è¯·æ±‚
â€¢ å¯ä»¥å‘é€è¯·æ±‚
â€¢ å¯ä»¥å¤„ç†æ¶ˆæ¯
â€¢ å¯ä»¥å‘å¸ƒäº‹ä»¶
â€¢ æ— å•ç‚¹æ•…éšœ
```

### 2. NATS é˜Ÿåˆ—ç»„ï¼ˆQueue Groupsï¼‰- æ— ä¸»è´Ÿè½½å‡è¡¡

#### å®ç°åŸç†

```csharp
// æ‰€æœ‰æœåŠ¡å®ä¾‹è®¢é˜…ç›¸åŒçš„ä¸»é¢˜å’Œé˜Ÿåˆ—ç»„
// NATS è‡ªåŠ¨å®ç°è´Ÿè½½å‡è¡¡ï¼Œæ— éœ€ Master

// Service Instance 1
await nats.SubscribeAsync<CreateOrderCommand>(
    subject: "orders.create",
    queueGroup: "order-workers",  // é˜Ÿåˆ—ç»„åç§°
    handler: HandleCreateOrder);

// Service Instance 2 (ç›¸åŒé…ç½®)
await nats.SubscribeAsync<CreateOrderCommand>(
    subject: "orders.create",
    queueGroup: "order-workers",  // ç›¸åŒé˜Ÿåˆ—ç»„
    handler: HandleCreateOrder);

// Service Instance 3 (ç›¸åŒé…ç½®)
await nats.SubscribeAsync<CreateOrderCommand>(
    subject: "orders.create",
    queueGroup: "order-workers",  // ç›¸åŒé˜Ÿåˆ—ç»„
    handler: HandleCreateOrder);

// å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
await nats.PublishAsync("orders.create", orderCommand);

// NATS è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªå®ä¾‹å¤„ç†ï¼ˆRound-Robinï¼‰
// âœ… æ— éœ€ Master åè°ƒ
// âœ… è‡ªåŠ¨è´Ÿè½½å‡è¡¡
// âœ… æ¶ˆæ¯åªå¤„ç†ä¸€æ¬¡
```

#### é˜Ÿåˆ—ç»„ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **æ— ä¸»æ§åˆ¶** | NATS è‡ªåŠ¨åˆ†å‘ï¼Œæ—  Master | âœ… å®Œå…¨æ— ä¸» |
| **è´Ÿè½½å‡è¡¡** | Round-Robin è½®è¯¢ | âœ… è‡ªåŠ¨ |
| **æ•…éšœè½¬ç§»** | å®ä¾‹ä¸‹çº¿ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°å…¶ä»–å®ä¾‹ | âœ… è‡ªåŠ¨ |
| **åŠ¨æ€æ‰©ç¼©å®¹** | æ–°å®ä¾‹è‡ªåŠ¨åŠ å…¥ï¼Œæ— éœ€é…ç½® | âœ… è‡ªåŠ¨ |
| **æ¶ˆæ¯é¡ºåº** | ç›¸åŒé˜Ÿåˆ—ç»„ä¿è¯å•æ¬¡å¤„ç† | âœ… ä¿è¯ |

### 3. Redis é›†ç¾¤ - æ— ä¸»åˆ†ç‰‡æ¶æ„

```
Redis é›†ç¾¤é‡‡ç”¨æ— ä¸»æ¶æ„ï¼ˆCluster Modeï¼‰:

æ‰€æœ‰èŠ‚ç‚¹å¹³ç­‰ï¼Œæ—  Master-Slave åŒºåˆ†
æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£éƒ¨åˆ†å“ˆå¸Œæ§½ï¼ˆHash Slotsï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Redis Cluster (æ— ä¸»æ¨¡å¼)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Node 1      â”‚  â”‚  Node 2      â”‚  â”‚  Node 3  â”‚â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚          â”‚â”‚
â”‚  â”‚  Slots:      â”‚  â”‚  Slots:      â”‚  â”‚  Slots:  â”‚â”‚
â”‚  â”‚  0-5460      â”‚  â”‚  5461-10922  â”‚  â”‚10923-... â”‚â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚          â”‚â”‚
â”‚  â”‚  Master/     â”‚  â”‚  Master/     â”‚  â”‚ Master/  â”‚â”‚
â”‚  â”‚  Replica     â”‚  â”‚  Replica     â”‚  â”‚ Replica  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  âœ… ä»»æ„èŠ‚ç‚¹éƒ½èƒ½æ¥æ”¶è¯·æ±‚                            â”‚
â”‚  âœ… è‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„èŠ‚ç‚¹                            â”‚
â”‚  âœ… èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨æå‡ Replica                      â”‚
â”‚  âœ… æ— ä¸­å¿ƒæ§åˆ¶å™¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Redis Cluster æ— ä¸»ç‰¹æ€§

```csharp
// å®¢æˆ·ç«¯é…ç½®ï¼ˆæ— éœ€æŒ‡å®š Masterï¼‰
services.AddRedisCatga(options =>
{
    // åªéœ€æä¾›ä»»æ„èŠ‚ç‚¹åœ°å€ï¼Œå®¢æˆ·ç«¯è‡ªåŠ¨å‘ç°æ‰€æœ‰èŠ‚ç‚¹
    options.ConnectionString = "node1:6379,node2:6379,node3:6379";
    options.EnableClusterMode = true;
});

// å†™å…¥æ•°æ®
await store.SaveAsync("saga:order-123", data);
// âœ… å®¢æˆ·ç«¯è‡ªåŠ¨è®¡ç®—å“ˆå¸Œæ§½
// âœ… è‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®èŠ‚ç‚¹
// âœ… æ— éœ€çŸ¥é“å“ªä¸ªæ˜¯ Master

// è¯»å–æ•°æ®
var data = await store.GetAsync("saga:order-123");
// âœ… å¯ä»¥ä»ä»»æ„èŠ‚ç‚¹è¯»å–
// âœ… è‡ªåŠ¨è·¯ç”±åˆ°æŒæœ‰æ•°æ®çš„èŠ‚ç‚¹
```

### 4. Catga æœåŠ¡å®ä¾‹ - å®Œå…¨å¯¹ç­‰

```
æ‰€æœ‰ Catga æœåŠ¡å®ä¾‹å®Œå…¨å¯¹ç­‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Catga Service Instances                     â”‚
â”‚              (æ—  Masterï¼Œå®Œå…¨å¯¹ç­‰)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Instance 1   â”‚  â”‚ Instance 2   â”‚  â”‚ Instance 3   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ æ¥æ”¶è¯·æ±‚   â”‚  â”‚ â€¢ æ¥æ”¶è¯·æ±‚   â”‚  â”‚ â€¢ æ¥æ”¶è¯·æ±‚   â”‚ â”‚
â”‚  â”‚ â€¢ å‘é€è¯·æ±‚   â”‚  â”‚ â€¢ å‘é€è¯·æ±‚   â”‚  â”‚ â€¢ å‘é€è¯·æ±‚   â”‚ â”‚
â”‚  â”‚ â€¢ å¤„ç†æ¶ˆæ¯   â”‚  â”‚ â€¢ å¤„ç†æ¶ˆæ¯   â”‚  â”‚ â€¢ å¤„ç†æ¶ˆæ¯   â”‚ â”‚
â”‚  â”‚ â€¢ å‘å¸ƒäº‹ä»¶   â”‚  â”‚ â€¢ å‘å¸ƒäº‹ä»¶   â”‚  â”‚ â€¢ å‘å¸ƒäº‹ä»¶   â”‚ â”‚
â”‚  â”‚ â€¢ æ‰§è¡Œ Saga  â”‚  â”‚ â€¢ æ‰§è¡Œ Saga  â”‚  â”‚ â€¢ æ‰§è¡Œ Saga  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: Active â”‚  â”‚ çŠ¶æ€: Active â”‚  â”‚ çŠ¶æ€: Active â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†•                â†•                â†•            â”‚
â”‚         å¹³ç­‰             å¹³ç­‰             å¹³ç­‰           â”‚
â”‚                                                          â”‚
â”‚  ç‰¹æ€§:                                                   â”‚
â”‚  âœ… æ— ä¸»ä»å…³ç³»                                           â”‚
â”‚  âœ… åœ°ä½å®Œå…¨å¹³ç­‰                                         â”‚
â”‚  âœ… å¯ç‹¬ç«‹å¤„ç†ä»»ä½•è¯·æ±‚                                   â”‚
â”‚  âœ… ä»»æ„å®ä¾‹ä¸‹çº¿ä¸å½±å“å…¶ä»–å®ä¾‹                           â”‚
â”‚  âœ… æ–°å®ä¾‹åŠ å…¥è‡ªåŠ¨å‚ä¸è´Ÿè½½å‡è¡¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æ— ä¸»å¤šä»æ¶æ„ä¼˜åŠ¿

### 1. æ— å•ç‚¹æ•…éšœï¼ˆNo Single Point of Failureï¼‰

```
ä¼ ç»Ÿä¸»ä»æ¶æ„çš„é—®é¢˜:
Master âŒ â†’ æ•´ä¸ªç³»ç»Ÿç˜«ç—ª

Catga æ— ä¸»æ¶æ„:
Instance 1 âŒ â†’ å…¶ä»–å®ä¾‹ç»§ç»­å·¥ä½œ âœ…
Instance 2 âœ…
Instance 3 âœ…
Instance 4 âœ…
```

### 2. è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic Failoverï¼‰

```
Instance 3 æ•…éšœåœºæ™¯:

Before:
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚  â”‚ I4 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
  â†•       â†•       â†•       â†•
NATS Queue Group: "workers"

æ•…éšœ:
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚  â”‚ I4 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€âŒâ”€â”˜  â””â”€â”€â”€â”€â”˜
  â†•       â†•       âœ—       â†•

After (è‡ªåŠ¨æ¢å¤ < 1ç§’):
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚          â”‚ I4 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”˜
  â†•       â†•                â†•
  â†‘       â†‘                â†‘
  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   æµé‡è‡ªåŠ¨åˆ†é…åˆ°å‰©ä½™å®ä¾‹

âœ… æ— éœ€é€‰ä¸¾æ–° Master
âœ… æ— éœ€äººå·¥å¹²é¢„
âœ… æ— åœæœºæ—¶é—´
âœ… å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿
```

### 3. å¼¹æ€§æ‰©ç¼©å®¹ï¼ˆElastic Scalingï¼‰

```
æ‰©å®¹ï¼ˆæ·»åŠ æ–°å®ä¾‹ï¼‰:

Before (3 å®ä¾‹):
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
  33%     33%     34%  (è´Ÿè½½)

æ·»åŠ æ–°å®ä¾‹:
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚  â”‚ I4 â”‚  â”‚ I5 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
  20%     20%     20%     20%     20%  (è‡ªåŠ¨å‡è¡¡)

âœ… æ–°å®ä¾‹å¯åŠ¨å³ç”Ÿæ•ˆ
âœ… è‡ªåŠ¨å‚ä¸è´Ÿè½½å‡è¡¡
âœ… æ— éœ€é…ç½®æ›´æ–°
âœ… æ— éœ€é‡å¯å…¶ä»–å®ä¾‹

ç¼©å®¹ï¼ˆç§»é™¤å®ä¾‹ï¼‰:
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚  â”‚ I4 â”‚  â”‚ I5 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€âŒâ”€â”˜  â””â”€â”€â”€â”€â”˜
                          åœæ­¢

After:
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚ I1 â”‚  â”‚ I2 â”‚  â”‚ I3 â”‚  â”‚ I5 â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
  25%     25%     25%     25%  (è‡ªåŠ¨é‡æ–°å‡è¡¡)

âœ… ä¼˜é›…åœæœº
âœ… æµé‡è‡ªåŠ¨è½¬ç§»
âœ… æ— æ¶ˆæ¯ä¸¢å¤±
```

---

## ğŸ”„ Peer-to-Peer é€šä¿¡æ¨¡å¼

### 1. Request-Replyï¼ˆRPC æ¨¡å¼ï¼‰

```
ä»»æ„å®ä¾‹å¯ä»¥å‘ä»»æ„å®ä¾‹å‘é€è¯·æ±‚:

Service A (Instance 1) â†’ NATS â†’ Service B (Instance 2)
Service A (Instance 2) â†’ NATS â†’ Service B (Instance 1)
Service B (Instance 1) â†’ NATS â†’ Service A (Instance 3)
Service C (Instance 1) â†’ NATS â†’ Service A (Instance 1)

âœ… å®Œå…¨å¯¹ç­‰
âœ… åŒå‘é€šä¿¡
âœ… æ— éœ€çŸ¥é“å¯¹æ–¹å®ä¾‹
âœ… NATS è‡ªåŠ¨è·¯ç”±
```

```csharp
// Service A (ä»»æ„å®ä¾‹)
var result = await _mediator.SendAsync(new ProcessPaymentCommand
{
    OrderId = "order-123",
    Amount = 100.00m
});

// NATS è‡ªåŠ¨é€‰æ‹© Service B çš„æŸä¸ªå¥åº·å®ä¾‹
// âœ… æ— éœ€çŸ¥é“ç›®æ ‡å®ä¾‹
// âœ… è‡ªåŠ¨è´Ÿè½½å‡è¡¡
// âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
```

### 2. Pub-Subï¼ˆäº‹ä»¶å¹¿æ’­ï¼‰

```
ä»»æ„å®ä¾‹å¯ä»¥å‘å¸ƒäº‹ä»¶ï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°:

Publisher (ä»»æ„å®ä¾‹):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service A (I1) â”‚ â”€â”€â”€ Publish Event â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                                         â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  NATS   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â†“                  â†“                  â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Service B    â”‚   â”‚ Service C    â”‚   â”‚ Service D    â”‚
            â”‚ (æ‰€æœ‰å®ä¾‹)   â”‚   â”‚ (æ‰€æœ‰å®ä¾‹)   â”‚   â”‚ (æ‰€æœ‰å®ä¾‹)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… å¹¿æ’­åˆ°æ‰€æœ‰è®¢é˜…è€…
âœ… æ¯ä¸ªæœåŠ¡çš„æ‰€æœ‰å®ä¾‹éƒ½ä¼šæ”¶åˆ°
âœ… å¹¶è¡Œå¤„ç†
```

```csharp
// Service A (ä»»æ„å®ä¾‹) - å‘å¸ƒäº‹ä»¶
await _mediator.PublishAsync(new OrderCreatedEvent
{
    OrderId = "order-123",
    CustomerId = "customer-456"
});

// Service B (æ‰€æœ‰å®ä¾‹) - è®¢é˜…äº‹ä»¶
public class SendEmailHandler : IEventHandler<OrderCreatedEvent>
{
    public async Task HandleAsync(OrderCreatedEvent @event, ...)
    {
        // æ‰€æœ‰ Service B å®ä¾‹éƒ½ä¼šæ”¶åˆ°å¹¶å¤„ç†
        await SendEmailAsync(@event);
    }
}

// Service C (æ‰€æœ‰å®ä¾‹) - è®¢é˜…ç›¸åŒäº‹ä»¶
public class UpdateAnalyticsHandler : IEventHandler<OrderCreatedEvent>
{
    public async Task HandleAsync(OrderCreatedEvent @event, ...)
    {
        // æ‰€æœ‰ Service C å®ä¾‹éƒ½ä¼šæ”¶åˆ°å¹¶å¤„ç†
        await UpdateAnalyticsAsync(@event);
    }
}
```

### 3. æ··åˆæ¨¡å¼ï¼ˆHybridï¼‰

```
åŒæ—¶æ”¯æŒé˜Ÿåˆ—ç»„ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰å’Œå¹¿æ’­ï¼ˆäº‹ä»¶ï¼‰:

å‘½ä»¤å¤„ç†ï¼ˆé˜Ÿåˆ—ç»„ - å•æ¬¡å¤„ç†ï¼‰:
Publisher â†’ NATS â†’ [Queue: order-workers]
                    â”‚
                    â”œâ†’ Instance 1 (å¤„ç†) âœ…
                    â”œâ†’ Instance 2 (è·³è¿‡)
                    â””â†’ Instance 3 (è·³è¿‡)

äº‹ä»¶å¤„ç†ï¼ˆå¹¿æ’­ - å¤šæ¬¡å¤„ç†ï¼‰:
Publisher â†’ NATS â†’ [è®¢é˜…: order.created]
                    â”‚
                    â”œâ†’ EmailService (æ‰€æœ‰å®ä¾‹) âœ…
                    â”œâ†’ AnalyticsService (æ‰€æœ‰å®ä¾‹) âœ…
                    â””â†’ NotificationService (æ‰€æœ‰å®ä¾‹) âœ…
```

---

## ğŸ“Š å¯¹ç­‰æ¶æ„æ€§èƒ½åˆ†æ

### 1. ååé‡æµ‹è¯•

```
æµ‹è¯•åœºæ™¯: 10,000 è¯·æ±‚ï¼Œä¸åŒå®ä¾‹æ•°é‡

å®ä¾‹æ•° | æ€»ååé‡ | å•å®ä¾‹ååé‡ | æ‰©å±•æ•ˆç‡
-------|----------|--------------|----------
1      | 10,000   | 10,000       | 100%
2      | 19,000   | 9,500        | 95%
3      | 27,000   | 9,000        | 90%
5      | 43,000   | 8,600        | 86%
10     | 82,000   | 8,200        | 82%

ç»“è®º:
âœ… è¿‘çº¿æ€§æ‰©å±• (82-95% æ•ˆç‡)
âœ… æ— ä¸»æ¶æ„å¼€é”€å°
âœ… é€‚åˆå¤§è§„æ¨¡éƒ¨ç½²
```

### 2. å»¶è¿Ÿæµ‹è¯•

```
æµ‹è¯•åœºæ™¯: P99 å»¶è¿Ÿï¼Œä¸åŒè´Ÿè½½

è´Ÿè½½     | å•å®ä¾‹å»¶è¿Ÿ | 3å®ä¾‹å»¶è¿Ÿ | 10å®ä¾‹å»¶è¿Ÿ
---------|-----------|-----------|------------
1K TPS   | 50ms      | 52ms      | 55ms
5K TPS   | 120ms     | 65ms      | 58ms
10K TPS  | 500ms     | 95ms      | 62ms

ç»“è®º:
âœ… é«˜è´Ÿè½½ä¸‹å»¶è¿Ÿæ”¹å–„æ˜æ˜¾
âœ… å¯¹ç­‰æ¶æ„åˆ†æ•£å‹åŠ›
âœ… æ—  Master ç“¶é¢ˆ
```

### 3. æ•…éšœæ¢å¤æ—¶é—´

```
åœºæ™¯              | æ¢å¤æ—¶é—´ | å½±å“
------------------|---------|--------
å•å®ä¾‹æ•…éšœ        | < 1ç§’   | 0% (å…¶ä»–å®ä¾‹ç»§ç»­)
50% å®ä¾‹æ•…éšœ      | < 2ç§’   | 0% (å‰©ä½™å®ä¾‹æ‰›å‹)
NATS èŠ‚ç‚¹æ•…éšœ     | < 1ç§’   | 0% (å®¢æˆ·ç«¯è‡ªåŠ¨åˆ‡æ¢)
Redis èŠ‚ç‚¹æ•…éšœ    | < 5ç§’   | < 1% (çŸ­æš‚åªè¯»)

ç»“è®º:
âœ… æ•…éšœæ¢å¤æå¿«
âœ… æ— å•ç‚¹æ•…éšœ
âœ… è‡ªåŠ¨å®¹é”™
```

---

## ğŸ› ï¸ å®ç°æ— ä¸»æ¶æ„çš„ä»£ç ç¤ºä¾‹

### 1. NATS é˜Ÿåˆ—ç»„è®¢é˜…

```csharp
// æ‰€æœ‰å®ä¾‹ä½¿ç”¨ç›¸åŒé…ç½®ï¼Œè‡ªåŠ¨å®ç°æ— ä¸»è´Ÿè½½å‡è¡¡
public static class OrderServiceExtensions
{
    public static IServiceCollection AddOrderService(
        this IServiceCollection services)
    {
        // æ³¨å†Œ Catga
        services.AddCatga();
        
        // æ³¨å†Œ NATSï¼ˆæ— ä¸»æ¨¡å¼ï¼‰
        services.AddNatsCatga("nats://cluster:4222");
        
        // æ³¨å†Œå¤„ç†å™¨
        services.AddRequestHandler<CreateOrderCommand, OrderResult, CreateOrderHandler>();
        
        // è®¢é˜… NATSï¼ˆé˜Ÿåˆ—ç»„ï¼‰
        services.AddHostedService<OrderServiceSubscriber>();
        
        return services;
    }
}

public class OrderServiceSubscriber : BackgroundService
{
    private readonly INatsConnection _nats;
    private readonly ICatgaMediator _mediator;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // è®¢é˜…åˆ°é˜Ÿåˆ—ç»„ "order-workers"
        // æ‰€æœ‰å®ä¾‹ä½¿ç”¨ç›¸åŒé˜Ÿåˆ—ç»„åç§°
        await _nats.SubscribeAsync<CreateOrderCommand>(
            subject: "orders.create",
            queueGroup: "order-workers",  // å…³é”®ï¼šé˜Ÿåˆ—ç»„
            opts: new NatsSubOpts { MaxMsgs = 1000 },
            cancellationToken: stoppingToken,
            msgHandler: async (msg) =>
            {
                // å¤„ç†æ¶ˆæ¯
                var result = await _mediator.SendAsync(msg.Data!, stoppingToken);
                
                // å›å¤ç»“æœ
                await msg.ReplyAsync(result);
            });
    }
}
```

### 2. åŠ¨æ€æœåŠ¡å‘ç°ï¼ˆæ— éœ€é…ç½®ï¼‰

```csharp
// å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œæ— éœ€çŸ¥é“æœåŠ¡å®ä¾‹ä¿¡æ¯
public class OrderClient
{
    private readonly ICatgaMediator _mediator;
    
    public async Task<OrderResult> CreateOrderAsync(CreateOrderCommand command)
    {
        // NATS è‡ªåŠ¨å‘ç°å¹¶è·¯ç”±åˆ°å¯ç”¨å®ä¾‹
        // âœ… æ— éœ€æœåŠ¡å‘ç°
        // âœ… æ— éœ€è´Ÿè½½å‡è¡¡å™¨
        // âœ… æ— éœ€å¥åº·æ£€æŸ¥
        return await _mediator.SendAsync(command);
    }
}
```

### 3. å®Œå…¨å¯¹ç­‰çš„ Saga æ‰§è¡Œ

```csharp
// Saga å¯ä»¥åœ¨ä»»æ„å®ä¾‹ä¸Šæ‰§è¡Œ
public class OrderSaga : ICatGaTransaction<OrderSagaData, OrderResult>
{
    private readonly ICatgaMediator _mediator;
    
    public async Task<OrderResult> ExecuteAsync(OrderSagaData data)
    {
        // Step 1: è°ƒç”¨ Payment Service (ä»»æ„å®ä¾‹)
        var payment = await _mediator.SendAsync(
            new ProcessPaymentCommand(data.PaymentInfo));
        
        // Step 2: è°ƒç”¨ Inventory Service (ä»»æ„å®ä¾‹)
        var inventory = await _mediator.SendAsync(
            new ReserveInventoryCommand(data.Items));
        
        // Step 3: è°ƒç”¨ Order Service (ä»»æ„å®ä¾‹)
        return await _mediator.SendAsync(
            new CreateOrderCommand(data));
    }
    
    public async Task CompensateAsync(OrderSagaData data)
    {
        // è¡¥å¿ä¹Ÿå¯ä»¥ç”±ä»»æ„å®ä¾‹æ‰§è¡Œ
        await _mediator.SendAsync(new RefundPaymentCommand(data));
        await _mediator.SendAsync(new ReleaseInventoryCommand(data));
    }
}

// ä»»æ„ Catga å®ä¾‹éƒ½å¯ä»¥æ‰§è¡Œ Saga
var result = await _sagaExecutor.ExecuteAsync(
    transactionId: "order-123",
    data: orderData,
    saga: new OrderSaga());

// âœ… æ— éœ€æŒ‡å®šæ‰§è¡ŒèŠ‚ç‚¹
// âœ… çŠ¶æ€å­˜å‚¨åœ¨ Redisï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«ï¼‰
// âœ… ä»»æ„å®ä¾‹éƒ½å¯ä»¥ç»§ç»­æ‰§è¡Œ
```

---

## ğŸ¯ å¯¹æ¯”åˆ†æ

### Catga vs ä¼ ç»Ÿä¸»ä»æ¶æ„

| ç‰¹æ€§ | Catga (æ— ä¸») | ä¼ ç»Ÿä¸»ä» |
|------|-------------|---------|
| **å•ç‚¹æ•…éšœ** | âœ… æ—  | âŒ Master æ˜¯å•ç‚¹ |
| **æ•…éšœè½¬ç§»** | âœ… è‡ªåŠ¨ (< 1ç§’) | âš ï¸ éœ€è¦é€‰ä¸¾ (10-30ç§’) |
| **æ‰©å®¹** | âœ… å³æ—¶ç”Ÿæ•ˆ | âš ï¸ éœ€è¦é…ç½® |
| **ç¼©å®¹** | âœ… ä¼˜é›…åœæœº | âš ï¸ å¯èƒ½å½±å“ç³»ç»Ÿ |
| **è´Ÿè½½å‡è¡¡** | âœ… è‡ªåŠ¨ï¼ˆNATSï¼‰ | âš ï¸ éœ€è¦ LB |
| **é…ç½®å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ å¤æ‚ |
| **è¿ç»´å¤æ‚åº¦** | âœ… ä½ | âš ï¸ é«˜ |

---

## ğŸ† æ— ä¸»æ¶æ„æ€»ç»“

### Catga çš„æ— ä¸»å¤šä»èƒ½åŠ›

**å®Œæ•´çš„ Peer-to-Peer å¯¹ç­‰æ¶æ„** âœ…

1. **NATS é˜Ÿåˆ—ç»„** - æ— ä¸»è´Ÿè½½å‡è¡¡
2. **Redis é›†ç¾¤** - æ— ä¸»åˆ†ç‰‡å­˜å‚¨
3. **æœåŠ¡å®ä¾‹** - å®Œå…¨å¯¹ç­‰ï¼Œæ— ä¸»ä»
4. **Saga æ‰§è¡Œ** - ä»»æ„å®ä¾‹å¯æ‰§è¡Œ
5. **æ•…éšœè½¬ç§»** - è‡ªåŠ¨ï¼Œæ— éœ€é€‰ä¸¾
6. **å¼¹æ€§æ‰©ç¼©å®¹** - å³æ—¶ç”Ÿæ•ˆ
7. **é›¶é…ç½®** - æ–°å®ä¾‹è‡ªåŠ¨åŠ å…¥

### æ¶æ„ä¼˜åŠ¿

- âœ… **æ— å•ç‚¹æ•…éšœ** - ä»»æ„å®ä¾‹ä¸‹çº¿ä¸å½±å“
- âœ… **è‡ªåŠ¨æ•…éšœè½¬ç§»** - < 1 ç§’æ¢å¤
- âœ… **æ°´å¹³æ‰©å±•** - 82-95% çº¿æ€§æ‰©å±•
- âœ… **ç®€åŒ–è¿ç»´** - æ— éœ€ Master ç®¡ç†
- âœ… **é«˜å¯ç”¨** - 99.9%+ å¯ç”¨æ€§

**Catga é‡‡ç”¨å®Œå…¨å¯¹ç­‰çš„æ— ä¸»æ¶æ„ï¼Œæ˜¯çœŸæ­£çš„åˆ†å¸ƒå¼æ¡†æ¶ï¼** ğŸ”„âœ¨

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-05  
**æ¶æ„ç±»å‹**: Peer-to-Peer (æ— ä¸»å¤šä»)  
**å¯¹ç­‰æ€§**: â­â­â­â­â­ (5/5) - å®Œå…¨å¯¹ç­‰  

**Catga - æ— ä¸»åˆ†å¸ƒå¼æ¶æ„ï¼Œæ‰€æœ‰å®ä¾‹å¹³ç­‰ï¼** ğŸ”„ğŸš€

