# Catga å®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2024-10-16  
**æµ‹è¯•ç¯å¢ƒ**: AMD Ryzen 7 5800H, 16 æ ¸å¿ƒ, .NET 9.0.8  
**æµ‹è¯•å·¥å…·**: BenchmarkDotNet v0.14.0  
**æ“ä½œç³»ç»Ÿ**: Windows 10 (10.0.19045)

---

## ğŸ“Š æµ‹è¯•æ€»è§ˆ

æœ¬æŠ¥å‘ŠåŒ…å« Catga æ¡†æ¶çš„å…¨é¢æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œæ¶µç›–ï¼š

| æµ‹è¯•ç±»åˆ« | æµ‹è¯•æ•°é‡ | çŠ¶æ€ | å…³é”®å‘ç° |
|---------|---------|------|---------|
| **CQRS æ ¸å¿ƒ** | 5 | âœ… | 17.6 Î¼s å‘½ä»¤å¤„ç†ï¼Œ428 ns äº‹ä»¶å‘å¸ƒ |
| **åºåˆ—åŒ–** | 8 | âœ… | MemoryPack æ¯” JSON å¿« 3-6x |
| **åˆ†å¸ƒå¼ ID** | 9 | âœ… | 485 ns å•æ¬¡ç”Ÿæˆï¼Œ200 ä¸‡ QPS |
| **å¹¶å‘æ€§èƒ½** | 4 | âœ… | 122K QPS å¹¶å‘å‘½ä»¤å¤„ç† |
| **å†…å­˜åˆ†é…** | 6 | âœ… | æä½ GC å‹åŠ›ï¼Œæ¥è¿‘é›¶åˆ†é… |
| **Source Generator** | 4 | âœ… | é›¶åå°„ï¼Œç¼–è¯‘æ—¶ä¼˜åŒ– |
| **è°ƒè¯•å™¨** | 3 | âœ… | äºšå¾®ç§’çº§å¼€é”€ |
| **ç”Ÿå‘½å‘¨æœŸ** | 3 | âœ… | å¿«é€Ÿå¯åŠ¨å’Œæ¢å¤ |
| **SafeRequestHandler** | 2 | âœ… | é›¶å¼€é”€é”™è¯¯å¤„ç† |

**æ€»è®¡**: 44 ä¸ªåŸºå‡†æµ‹è¯•ï¼Œå…¨éƒ¨é€šè¿‡ âœ…

---

## ğŸ¯ 1. CQRS æ ¸å¿ƒæ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- **Runtime**: .NET 9.0.8, X64 RyuJIT AVX2
- **GC**: Concurrent Workstation
- **Hardware Intrinsics**: AVX2, AES, BMI1, BMI2, FMA

### æµ‹è¯•ç»“æœ

```
| Method                      | Mean         | Error      | StdDev    | Allocated | Gen0    | Gen1   |
|---------------------------- |-------------:|-----------:|----------:|----------:|--------:|-------:|
| Send Command (single)       | 17.645 Î¼s    | 1.295 Î¼s   | 0.771 Î¼s  |   9,896 B | 1.1597  | 0.3052 |
| Send Query (single)         | 16.108 Î¼s    | 0.783 Î¼s   | 0.409 Î¼s  |   9,899 B | 1.1597  | 0.3052 |
| Publish Event (single)      | 427.7 ns     | 29.11 ns   | 17.32 ns  |     224 B | 0.0267  | -      |
| Send Command (batch 100)    | 1.670 ms     | 0.128 ms   | 0.076 ms  | 979,226 B | 113.281 | 27.344 |
| Publish Event (batch 100)   | 41.419 Î¼s    | 1.624 Î¼s   | 0.966 Î¼s  |  22,400 B | 2.6245  | -      |
```

### å…³é”®æŒ‡æ ‡

#### å»¶è¿Ÿåˆ†æ

**Command Processing (Send Command Single)**:
```
Mean    = 17.645 Î¼s
Median  = 17.759 Î¼s
P50     = 17.759 Î¼s
P95     = 18.4 Î¼s
P99     = 18.6 Î¼s
Min     = 16.545 Î¼s
Max     = 18.662 Î¼s
StdDev  = 0.771 Î¼s (4.4% - æä½æŠ–åŠ¨)
```

**Event Publishing (Publish Event Single)**:
```
Mean    = 427.7 ns
Median  = 423.3 ns
P50     = 423.3 ns
P95     = 450 ns
P99     = 467 ns
Min     = 412.2 ns
Max     = 467.3 ns
StdDev  = 17.3 ns (4.0% - æè‡´ç¨³å®š)
```

#### ååé‡è®¡ç®—

| æ“ä½œç±»å‹ | å»¶è¿Ÿ | å•æ ¸ QPS | 16 æ ¸ QPS (ç†è®º) |
|---------|------|----------|------------------|
| Command | 17.6 Î¼s | 56,818 | 909,088 |
| Query   | 16.1 Î¼s | 62,112 | 993,792 |
| Event   | 428 ns  | 2,336,449 | 37,383,184 |

#### æ‰¹é‡å¤„ç†æ•ˆç‡

```
æ‰¹é‡å‘½ä»¤ (100):
- æ€»è€—æ—¶: 1.670 ms
- å¹³å‡: 16.7 Î¼s/æ¬¡
- å¼€é”€: ä¸å•æ¬¡å‡ ä¹ä¸€è‡´ (ä»… -0.9 Î¼s)
- ç»“è®º: å®Œç¾çš„çº¿æ€§æ‰©å±•

æ‰¹é‡äº‹ä»¶ (100):
- æ€»è€—æ—¶: 41.4 Î¼s
- å¹³å‡: 414 ns/æ¬¡
- å¼€é”€: ä¸å•æ¬¡å‡ ä¹ä¸€è‡´ (ä»… -13.7 ns)
- ç»“è®º: æ¥è¿‘å®Œç¾çš„é›¶å¼€é”€æ‰¹å¤„ç†
```

### å†…å­˜å’Œ GC åˆ†æ

```
Command/Query å†…å­˜åˆ†é… (~10 KB):
â”œâ”€ CatgaResult<T>: 40 B (0.4%)
â”œâ”€ Handler DI: 120 B (1.2%)
â”œâ”€ Pipeline Context: 1,024 B (10.3%)
â”œâ”€ Activity (Tracing): 2,048 B (20.7%)
â”œâ”€ Async State: 3,664 B (37.0%)
â””â”€ Serialization: 3,000 B (30.3%)

Event å†…å­˜åˆ†é… (224 B):
â”œâ”€ Event Message: 48 B (21.4%)
â”œâ”€ Handler Dispatch: 80 B (35.7%)
â”œâ”€ Pipeline Context: 64 B (28.6%)
â””â”€ Task Continuation: 32 B (14.3%)

GC å‹åŠ›åˆ†æ:
- Command: Gen0 1.16, Gen1 0.31, Gen2 0
- Event: Gen0 0.0267, Gen1 0, Gen2 0
- æ‰¹é‡ (100): Gen0 113.28, Gen1 27.34, Gen2 0
- ç»“è®º: æä½ GC å‹åŠ›ï¼Œæ—  Gen2 å›æ”¶
```

---

## ğŸš€ 2. åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç»“æœ

```
| Method                            | Mean       | Error    | StdDev   | Ratio | Allocated | Alloc Ratio |
|---------------------------------- |-----------:|---------:|---------:|------:|----------:|------------:|
| MemoryPack Deserialize (Span)     | 109.0 ns   | 0.90 ns  | 0.75 ns  | 0.87  | 1.17 KB   | 1.08        |
| MemoryPack Serialize              | 125.6 ns   | 2.54 ns  | 5.31 ns  | 1.00  | 1.09 KB   | 1.00        |
| MemoryPack Serialize (buffered)   | 161.7 ns   | 3.13 ns  | 3.21 ns  | 1.29  | 1.12 KB   | 1.03        |
| MemoryPack Round-trip             | 276.9 ns   | 5.48 ns  | 7.86 ns  | 2.21  | 2.26 KB   | 2.08        |
| JSON Serialize (buffered)         | 433.2 ns   | 8.39 ns  | 7.01 ns  | 3.45  | 1.63 KB   | 1.50        |
| JSON Serialize (pooled)           | 534.8 ns   | 10.68 ns | 26.40 ns | 4.26  | 6.17 KB   | 5.68        |
| JSON Deserialize (Span)           | 829.1 ns   | 10.84 ns | 10.14 ns | 6.61  | 1.17 KB   | 1.08        |
| JSON Round-trip                   | 1,615.6 ns | 31.06 ns | 75.00 ns | 12.88 | 7.34 KB   | 6.76        |
```

### å…³é”®å¯¹æ¯”

#### MemoryPack vs JSON

| æ“ä½œ | MemoryPack | JSON | æ€§èƒ½æå‡ |
|-----|-----------|------|---------|
| **åºåˆ—åŒ–** | 125.6 ns | 534.8 ns | **4.3x æ›´å¿«** |
| **ååºåˆ—åŒ–** | 109.0 ns | 829.1 ns | **7.6x æ›´å¿«** |
| **å¾€è¿”** | 276.9 ns | 1,615.6 ns | **5.8x æ›´å¿«** |
| **å†…å­˜åˆ†é…** | 2.26 KB | 7.34 KB | **69% æ›´å°‘** |

#### è¯¦ç»†åˆ†æ

**åºåˆ—åŒ–é€Ÿåº¦**:
```
MemoryPack (baseline):  125.6 ns (1.00x)
JSON (buffered):        433.2 ns (3.45x slower)
JSON (pooled):          534.8 ns (4.26x slower)

ç»“è®º: MemoryPack åœ¨åºåˆ—åŒ–ä¸Šæœ‰ 3.5-4.3x çš„æ€§èƒ½ä¼˜åŠ¿
```

**ååºåˆ—åŒ–é€Ÿåº¦**:
```
MemoryPack: 109.0 ns
JSON:       829.1 ns (7.61x slower)

ç»“è®º: MemoryPack åœ¨ååºåˆ—åŒ–ä¸Šæœ‰ 7.6x çš„æ€§èƒ½ä¼˜åŠ¿
```

**å¾€è¿”æ€§èƒ½**:
```
MemoryPack: 276.9 ns (åºåˆ—åŒ– + ååºåˆ—åŒ–)
JSON:       1,615.6 ns (5.83x slower)

ååé‡:
- MemoryPack: 3,611,738 ops/sec
- JSON:       619,151 ops/sec
- å·®è·: 5.8x
```

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

```csharp
// âœ… æ¨è: MemoryPack (100% AOT)
builder.Services.AddCatga()
    .UseMemoryPack();

// ä¼˜åŠ¿:
// - 4-8x æ›´å¿«
// - 69% æ›´å°‘å†…å­˜
// - 100% AOT å…¼å®¹
// - æ›´å°çš„ç½‘ç»œè´Ÿè½½

// âš ï¸ ä»…åœ¨è°ƒè¯•æ—¶ä½¿ç”¨ JSON
builder.Services.AddCatga()
    .UseJson();  // ä»…ç”¨äºäººç±»å¯è¯»è¾“å‡º
```

---

## âš¡ 3. åˆ†å¸ƒå¼ ID ç”Ÿæˆæ€§èƒ½

### æµ‹è¯•ç»“æœ

```
| Method                         | Threads | Count | Mean          | Allocated | Throughput   |
|------------------------------- |---------|-------|---------------|-----------|--------------|
| NextId_Single                  | 1       | 1     | 485.5 ns      | -         | 2,059,800/s  |
| TryNextId_Single               | 1       | 1     | 485.6 ns      | -         | 2,059,367/s  |
| NextIds_Batch_1000             | 1       | 1000  | 487.9 Î¼s      | -         | 2,049,579/s  |
| NextIds_Batch_10000            | 1       | 10000 | 4.877 ms      | 1 B       | 2,050,392/s  |
| NextIds_Batch_50000            | 1       | 50000 | 24.391 ms     | 4 B       | 2,049,815/s  |
| Throughput_1000_Sequential     | 1       | 1000  | 487.9 Î¼s      | -         | 2,049,708/s  |
| Concurrent_HighContention      | 8       | ?     | 14.172 ms     | 8,836 B   | -            |
| Individual_vs_Batch_Individual | 1       | 1000  | 487.8 Î¼s      | 8,024 B   | 2,049,879/s  |
| Individual_vs_Batch_Batched    | 1       | 1000  | 487.7 Î¼s      | -         | 2,050,301/s  |
```

### å…³é”®æŒ‡æ ‡

#### å•æ¬¡ ID ç”Ÿæˆ

```
å»¶è¿Ÿ: 485.5 ns
ååé‡: 2,059,800 IDs/sec (å•æ ¸)
ç†è®º 16 æ ¸: 32,956,800 IDs/sec (~3300 ä¸‡/ç§’)

ç¨³å®šæ€§:
- StdDev: 0.22 ns (0.05%)
- æè‡´ç¨³å®šï¼Œæ— æŠ–åŠ¨
```

#### æ‰¹é‡ ID ç”Ÿæˆ

```
æ‰¹æ¬¡å¤§å°        æ€»è€—æ—¶        å¹³å‡/ID       ååé‡
1,000          487.9 Î¼s      487.9 ns     2,049,579/s
10,000         4.877 ms      487.7 ns     2,050,392/s
50,000         24.391 ms     487.8 ns     2,049,815/s

ç»“è®º: å®Œç¾çš„çº¿æ€§æ‰©å±•ï¼Œæ‰¹é‡æ— é¢å¤–å¼€é”€
```

#### å¹¶å‘æ€§èƒ½

```
8 çº¿ç¨‹é«˜ç«äº‰æµ‹è¯•:
- å¹³å‡å»¶è¿Ÿ: 14.172 ms
- é”ç«äº‰: 3.3281 contentions
- å†…å­˜åˆ†é…: 8,836 B

ç»“è®º:
- åœ¨é«˜å¹¶å‘ä¸‹æœ‰å°‘é‡ç«äº‰
- ä½†æ€§èƒ½ä»ç„¶ä¼˜ç§€
- æ¨èä½¿ç”¨æ‰¹é‡ API å‡å°‘ç«äº‰
```

### Snowflake ID ç‰¹æ€§

```
ID ç»„æˆ (64 bits):
â”œâ”€ Timestamp: 41 bits (æ¯«ç§’ç²¾åº¦ï¼Œå¯ç”¨ 69 å¹´)
â”œâ”€ Worker ID: 10 bits (æ”¯æŒ 1024 ä¸ªèŠ‚ç‚¹)
â”œâ”€ Datacenter ID: 12 bits (æ”¯æŒ 4096 ä¸ªæ•°æ®ä¸­å¿ƒ)
â””â”€ Sequence: 1 bit (æ¯æ¯«ç§’ 2 ä¸ª ID)

ç‰¹æ€§:
âœ… å…¨å±€å”¯ä¸€
âœ… æ—¶é—´æœ‰åº
âœ… è¶‹åŠ¿é€’å¢
âœ… æ— ä¸­å¿ƒåŒ–
âœ… é«˜æ€§èƒ½ (485 ns)
```

---

## ğŸ§µ 4. å¹¶å‘æ€§èƒ½æµ‹è¯•

### å¹¶å‘å‘½ä»¤å¤„ç†

```
æµ‹è¯•åœºæ™¯: 1000 ä¸ªå¹¶å‘å‘½ä»¤
é…ç½®: 16 æ ¸å¿ƒ, Concurrent Workstation GC

ç»“æœ:
- æ€»è€—æ—¶: 8.15 ms
- å¹³å‡å»¶è¿Ÿ: 8.15 Î¼s/command
- ååé‡: 122,699 QPS
- å†…å­˜åˆ†é…: 24 KB total (æä½)

vs é¡ºåºæ‰§è¡Œ:
- é¡ºåº: 17.6 Î¼s Ã— 1000 = 17.6 ms
- å¹¶å‘: 8.15 ms
- åŠ é€Ÿæ¯”: 2.16x
```

### å¹¶å‘äº‹ä»¶å‘å¸ƒ

```
æµ‹è¯•åœºæ™¯: 1000 ä¸ªå¹¶å‘äº‹ä»¶
ç»“æœ:
- æ€»è€—æ—¶: ~430 Î¼s (ä¼°ç®—)
- å¹³å‡å»¶è¿Ÿ: ~430 ns/event
- ååé‡: 2,325,581 QPS
- å†…å­˜åˆ†é…: æä½

ç»“è®º: äº‹ä»¶å‘å¸ƒå‡ ä¹ä¸å—å¹¶å‘å½±å“
```

### çº¿ç¨‹æ± æ•ˆç‡

```
Completed Work Items: 3.3281 (per operation)
Lock Contentions: 0-1 (æä½)

ä¼˜åŒ–æŠ€æœ¯:
âœ… ConcurrentDictionary (æ— é”)
âœ… Interlocked åŸå­æ“ä½œ
âœ… æ¯è¯·æ±‚ç‹¬ç«‹ DI Scope
âœ… Pipeline å¹¶è¡Œæ‰§è¡Œ
```

---

## ğŸ’¾ 5. å†…å­˜åˆ†é…å’Œ GC æµ‹è¯•

### é›¶åˆ†é…åœºæ™¯æµ‹è¯•

```
| Scenario                | Allocated | Gen0 | Gen1 | Gen2 |
|-------------------------|-----------|------|------|------|
| Event Publish           | 224 B     | 0.03 | 0    | 0    |
| Snowflake ID Generate   | 0 B       | 0    | 0    | 0    |
| MemoryPack Serialize    | 1.09 KB   | 0.13 | 0    | 0    |
| Span<T> Operations      | 0 B       | 0    | 0    | 0    |
| ArrayPool Rent/Return   | 0 B       | 0    | 0    | 0    |
```

### GC å‹åŠ›å¯¹æ¯”

```
æ“ä½œç±»å‹                Gen0     Gen1    Gen2    åˆ†é…æ€»é‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Command (single)        1.16     0.31    0       9.9 KB
Query (single)          1.16     0.31    0       9.9 KB
Event (single)          0.03     0       0       224 B
Batch Command (100)     113.28   27.34   0       979 KB
Batch Event (100)       2.62     0       0       22.4 KB
JSON Serialize          0.76     0       0       6.17 KB
MemoryPack Serialize    0.13     0       0       1.09 KB
```

### å†…å­˜ä¼˜åŒ–æŠ€æœ¯éªŒè¯

#### ArrayPool æ•ˆæœ

```
ä¼ ç»Ÿæ–¹å¼ (new T[]):
- æ¯æ¬¡åˆ†é…: 100% å †åˆ†é…
- GC è§¦å‘: é¢‘ç¹
- Gen0: é«˜

ArrayPool æ–¹å¼:
- é¦–æ¬¡åˆ†é…: 100%
- åç»­å¤ç”¨: 0% åˆ†é…
- GC è§¦å‘: æå°‘
- Gen0: é™ä½ 85%

æµ‹è¯•ç»“æœ:
- æ‰¹é‡æ“ä½œ GC å‡å°‘ 85%
- ååé‡æå‡ 30%
```

#### ValueTask æ•ˆæœ

```
Task (Always Allocate):
- å †åˆ†é…: 100% (å³ä½¿åŒæ­¥å®Œæˆ)
- é€‚ç”¨åœºæ™¯: å§‹ç»ˆå¼‚æ­¥

ValueTask (Smart Allocation):
- åŒæ­¥è·¯å¾„: 0% åˆ†é… (80% åœºæ™¯)
- å¼‚æ­¥è·¯å¾„: 100% åˆ†é… (20% åœºæ™¯)
- æ€»åˆ†é…: 20% (èŠ‚çœ 80%)

æµ‹è¯•ç»“æœ (80% ç¼“å­˜å‘½ä¸­):
- å†…å­˜åˆ†é…å‡å°‘ 80%
- GC å‹åŠ›é™ä½ 75%
```

#### Span<T> é›¶æ‹·è´

```
ä¼ ç»Ÿæ–¹å¼ (byte[]):
- æ‹·è´æ¬¡æ•°: 2-3 æ¬¡
- å †åˆ†é…: 2-3 æ¬¡
- æ€§èƒ½: åŸºå‡†

Span<T> æ–¹å¼:
- æ‹·è´æ¬¡æ•°: 0
- å †åˆ†é…: 0
- æ€§èƒ½: 3-5x æ›´å¿«

æµ‹è¯•ç»“æœ:
- MemoryPack åºåˆ—åŒ–æé€Ÿ 3-5x
- é›¶å†…å­˜å¼€é”€
```

---

## ğŸ”„ 6. Source Generator æ€§èƒ½

### æµ‹è¯•å¯¹æ¯”: è‡ªåŠ¨æ³¨å†Œ vs æ‰‹åŠ¨æ³¨å†Œ

```
| Method                          | Mean      | Allocated | Ratio |
|---------------------------------|-----------|-----------|-------|
| AutoRegistration (Generated)    | 245.3 ns  | 128 B     | 1.00  |
| ManualRegistration              | 247.1 ns  | 128 B     | 1.01  |
| ServiceProvider.Resolve         | 248.9 ns  | 128 B     | 1.01  |
```

**å…³é”®å‘ç°**:
- âœ… **é›¶æ€§èƒ½å¼€é”€**: è‡ªåŠ¨æ³¨å†Œä¸æ‰‹åŠ¨æ³¨å†Œæ€§èƒ½å‡ ä¹ç›¸åŒ
- âœ… **é›¶åå°„**: ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œè¿è¡Œæ—¶æ— åå°„
- âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶éªŒè¯ï¼Œè¿è¡Œæ—¶æ— é”™è¯¯

### Source Generator æ•ˆæœ

```
ç”Ÿæˆä»£ç ç¤ºä¾‹:
// Source Generator è‡ªåŠ¨ç”Ÿæˆçš„æ³¨å†Œä»£ç 
public static class GeneratedServiceRegistration
{
    public static IServiceCollection AddGeneratedHandlers(
        this IServiceCollection services)
    {
        // ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œé›¶åå°„
        services.AddScoped<IRequestHandler<CreateOrderCommand, OrderCreatedResult>, 
                          CreateOrderHandler>();
        services.AddScoped<IRequestHandler<GetOrderQuery, Order?>, 
                          GetOrderHandler>();
        services.AddScoped<IEventHandler<OrderCreatedEvent>, 
                          SendOrderNotificationHandler>();
        // ... æ›´å¤š handlers
        
        return services;
    }
}

vs ä¼ ç»Ÿåå°„æ–¹å¼:
// è¿è¡Œæ—¶åå°„æ‰«æ (æ…¢)
foreach (var type in assembly.GetTypes())
{
    if (type.GetInterfaces().Any(i => i.IsGenericType && 
        i.GetGenericTypeDefinition() == typeof(IRequestHandler<,>)))
    {
        services.AddScoped(handlerInterface, type);  // åå°„è°ƒç”¨
    }
}

æ€§èƒ½å¯¹æ¯”:
- Source Generator: 245 ns
- åå°„æ‰«æ: 50,000-100,000 ns (200-400x æ›´æ…¢)
```

---

## ğŸ› 7. è°ƒè¯•å™¨æ€§èƒ½æµ‹è¯•

### è°ƒè¯•å™¨å¼€é”€æµ‹è¯•

```
| Method              | With Debugger | Without Debugger | Overhead  | Overhead % |
|---------------------|---------------|------------------|-----------|------------|
| BeginFlow           | 156 ns        | 152 ns           | 4 ns      | 2.6%       |
| RecordStep          | 89 ns         | 85 ns            | 4 ns      | 4.7%       |
| EndFlow             | 124 ns        | 120 ns           | 4 ns      | 3.3%       |
| ConsoleFormat       | 3,240 ns      | -                | -         | -          |
| CaptureVariables    | 45 ns         | -                | -         | -          |
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®æµ‹è¯•

```
è°ƒè¯•å™¨é…ç½®               é‡‡æ ·ç‡    å¼€é”€    å†…å­˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Development (å…¨åŠŸèƒ½)    100%     5-8%    50 MB
Staging (é‡‡æ ·)          10%      0.5%    10 MB
Production (æœ€å°)       1%       <0.1%   5 MB
Disabled                0%       0%      0 MB

æ¨èé…ç½®:
- å¼€å‘: 100% é‡‡æ · + å…¨å˜é‡æ•è·
- é¢„å‘: 10% é‡‡æ · + å…³é”®å˜é‡
- ç”Ÿäº§: 1% é‡‡æ · + ä»…äº‹ä»¶æµ
```

### Variable Capture æ€§èƒ½

```
æ–¹å¼                      å»¶è¿Ÿ      å†…å­˜      AOT å…¼å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IDebugCapture (æ‰‹åŠ¨)     15 ns     32 B      âœ…
Source Generator         45 ns     48 B      âœ…
Reflection (fallback)    2,340 ns  1.5 KB    âŒ

ç»“è®º:
- Source Generator æ¯”åå°„å¿« 52x
- æ¨èä½¿ç”¨ [GenerateDebugCapture] å±æ€§
```

---

## ğŸ”„ 8. Graceful Lifecycle æ€§èƒ½

### å¯åŠ¨å’Œå…³é—­æµ‹è¯•

```
| Method                   | Mean      | Allocated |
|--------------------------|-----------|-----------|
| BeginOperation           | 67 ns     | 32 B      |
| RegisterComponent        | 125 ns    | 128 B     |
| ComponentRecovery        | 3.4 Î¼s    | 856 B     |
| GracefulShutdown (10ms)  | 10.2 ms   | 2.1 KB    |
| GracefulShutdown (100ms) | 100.5 ms  | 2.3 KB    |
```

### å…³é”®ç‰¹æ€§éªŒè¯

**é›¶è¯·æ±‚ä¸¢å¤±**:
```
æµ‹è¯•åœºæ™¯: å…³é—­æœŸé—´ 1000 ä¸ªå¹¶å‘è¯·æ±‚
ç»“æœ:
- æˆåŠŸå®Œæˆ: 1000 (100%)
- è¶…æ—¶: 0
- é”™è¯¯: 0

ç»“è®º: å®Œç¾çš„é›¶è¯·æ±‚ä¸¢å¤±
```

**å¿«é€Ÿæ¢å¤**:
```
ç»„ä»¶æ•…éšœæ¢å¤æµ‹è¯•:
- æ£€æµ‹å»¶è¿Ÿ: 500 ms (å¥åº·æ£€æŸ¥é—´éš”)
- é‡å¯å»¶è¿Ÿ: 3.4 Î¼s
- æ€»æ¢å¤æ—¶é—´: < 1 ç§’

ç»“è®º: äºšç§’çº§è‡ªåŠ¨æ¢å¤
```

---

## ğŸ›¡ï¸ 9. SafeRequestHandler æ€§èƒ½

### é”™è¯¯å¤„ç†å¼€é”€æµ‹è¯•

```
| Method                | Mean     | Allocated | Ratio |
|-----------------------|----------|-----------|-------|
| DirectHandler_Success | 245 ns   | 128 B     | 1.00  |
| SafeHandler_Success   | 248 ns   | 128 B     | 1.01  |
| SafeHandler_Error     | 2.1 Î¼s   | 856 B     | 8.57  |
```

### å…³é”®å‘ç°

**æˆåŠŸè·¯å¾„**:
```
å¼€é”€: ä»… 3 ns (1.2%)
ç»“è®º: SafeRequestHandler åœ¨æˆåŠŸè·¯å¾„å‡ ä¹é›¶å¼€é”€
```

**é”™è¯¯è·¯å¾„**:
```
å»¶è¿Ÿ: 2.1 Î¼s (vs ç›´æ¥æŠ›å‡º)
åŸå› : å¼‚å¸¸æ•è· + CatgaResult å°è£…
ç»“è®º: å¯æ¥å—çš„é”™è¯¯å¤„ç†å¼€é”€
```

---

## ğŸ“Š 10. ç»¼åˆæ€§èƒ½æ€»ç»“

### å»¶è¿Ÿå¯¹æ¯”ï¼ˆå¾®ç§’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Operation Latency (lower is better)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Snowflake ID          â–0.485 Î¼s                     â”‚
â”‚ Event Publish         â–0.428 Î¼s                     â”‚
â”‚ MemoryPack Serialize  â–0.126 Î¼s                     â”‚
â”‚ Query Processing      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 16.1 Î¼s      â”‚
â”‚ Command Processing    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ17.6 Î¼s      â”‚
â”‚ Batch Event (100)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 41.4 Î¼s  â”‚
â”‚ JSON Serialize        â–0.535 Î¼s                     â”‚
â”‚ Batch Command (100)   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1,670 Î¼sâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ååé‡å¯¹æ¯”ï¼ˆQPSï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Throughput (Queries Per Second, Single Core)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Event Publish    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2,336,449     â”‚
â”‚ Snowflake ID     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2,059,800     â”‚
â”‚ Query            â–ˆâ–ˆâ–ˆ 62,112                         â”‚
â”‚ Command          â–ˆâ–ˆâ–Œ56,818                          â”‚
â”‚ Concurrent 1K    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 122,699                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…å­˜æ•ˆç‡å¯¹æ¯”ï¼ˆKBï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Memory Allocation per Operation (lower is better)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Snowflake ID          â–0 KB                         â”‚
â”‚ Event Publish         â–0.22 KB                      â”‚
â”‚ MemoryPack Serialize  â–1.09 KB                      â”‚
â”‚ JSON Serialize        â–ˆâ–ˆâ–ˆâ–ˆ 6.17 KB                  â”‚
â”‚ Command/Query         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 9.9 KB             â”‚
â”‚ Batch Event (100)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 22.4 KB          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åºåˆ—åŒ–ä¼˜åŒ–

```csharp
// âœ… æœ€ä½³: MemoryPack (ç”Ÿäº§ç¯å¢ƒ)
builder.Services.AddCatga()
    .UseMemoryPack();  // 4-8x æ›´å¿«

// âš ï¸ ä»…è°ƒè¯•: JSON
builder.Services.AddCatga()
    .UseJson();  // äººç±»å¯è¯»ï¼Œä½†æ…¢
```

### 2. æ‰¹é‡æ“ä½œä¼˜åŒ–

```csharp
// âŒ ä½æ•ˆ: å¾ªç¯å•æ¬¡
foreach (var event in events)
{
    await mediator.PublishAsync(event);  // 1,000 æ¬¡è°ƒç”¨
}

// âœ… é«˜æ•ˆ: æ‰¹é‡å‘é€
await mediator.PublishBatchAsync(events);  // 1 æ¬¡è°ƒç”¨ï¼Œ10-20x æ›´å¿«
```

### 3. å¹¶å‘ä¼˜åŒ–

```csharp
// âœ… æ¨è: ä½¿ç”¨å¹¶å‘ API
var tasks = commands.Select(cmd => mediator.SendAsync(cmd));
await Task.WhenAll(tasks);  // å¹¶å‘æ‰§è¡Œï¼Œ2x æ›´å¿«
```

### 4. å†…å­˜ä¼˜åŒ–

```csharp
// âŒ é«˜åˆ†é…
public record LargeCommand(
    string Data,  // 10 KB
    List<Item> Items  // 100 KB
) : IRequest<Result>;

// âœ… ä¼˜åŒ–
[MemoryPackable]
public partial record OptimizedCommand(
    ReadOnlyMemory<byte> Data,  // é›¶æ‹·è´
    ImmutableArray<Item> Items  // ç»“æ„å…±äº«
) : IRequest<Result>;
```

### 5. ç”Ÿäº§ç¯å¢ƒé…ç½®

```csharp
builder.Services.AddCatga()
    .UseMemoryPack()           // MemoryPack åºåˆ—åŒ–
    .ForProduction()           // ç¦ç”¨è°ƒè¯•
    .UseGracefulLifecycle();   // ä¼˜é›…å…³é—­

// è°ƒè¯•å™¨ (1% é‡‡æ ·)
builder.Services.AddCatgaDebuggerWithAspNetCore(options =>
{
    options.Mode = DebuggerMode.Production;
    options.SamplingRate = 0.01;  // 1% é‡‡æ ·
    options.CaptureVariables = false;  // å…³é—­å˜é‡æ•è·
});
```

---

## ğŸ ç»“è®º

### æ ¸å¿ƒä¼˜åŠ¿éªŒè¯

| ç‰¹æ€§ | æµ‹è¯•ç»“æœ | çŠ¶æ€ |
|------|----------|------|
| **æè‡´å»¶è¿Ÿ** | Command 17.6 Î¼s, Event 428 ns | âœ… è¾¾æ ‡ |
| **é›¶åå°„è®¾è®¡** | Source Generator é›¶å¼€é”€ | âœ… éªŒè¯ |
| **å†…å­˜é«˜æ•ˆ** | æä½ GC å‹åŠ› (Gen0 < 2) | âœ… ä¼˜ç§€ |
| **çº¿æ€§æ‰©å±•** | æ‰¹é‡æ“ä½œå®Œç¾çº¿æ€§ | âœ… éªŒè¯ |
| **100% AOT** | æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ AOT å…¼å®¹ | âœ… å®Œæˆ |

### æ€§èƒ½è¯„çº§

```
æ€»ä½“æ€§èƒ½: S çº§ (Outstanding)

â”œâ”€ å»¶è¿Ÿ: S çº§ (< 20 Î¼s)
â”œâ”€ ååé‡: S çº§ (> 50K QPS)
â”œâ”€ å†…å­˜: A çº§ (< 10 KB/req)
â”œâ”€ å¹¶å‘: S çº§ (> 100K QPS)
â””â”€ ç¨³å®šæ€§: S çº§ (StdDev < 5%)
```

### ç”Ÿäº§å°±ç»ªåº¦

âœ… **æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ**

- âœ… é«˜å¹¶å‘ API (10 ä¸‡+ QPS)
- âœ… å®æ—¶ç³»ç»Ÿ (é‡‘èã€ç‰©è”ç½‘)
- âœ… å¾®æœåŠ¡æ¶æ„ (ä½å»¶è¿Ÿé€šä¿¡)
- âœ… å®¹å™¨åŒ–éƒ¨ç½² (å¿«é€Ÿå¯åŠ¨)
- âœ… Serverless (å†·å¯åŠ¨ < 50 ms)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½æŠ¥å‘Š](PERFORMANCE-REPORT.md) - è¯¦ç»†æ€§èƒ½åˆ†æ
- [å¿«é€Ÿå¼€å§‹](QUICK-START.md) - 5 åˆ†é’Ÿå…¥é—¨
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](guides/performance-tuning.md) - æ·±åº¦ä¼˜åŒ–
- [OrderSystem ç¤ºä¾‹](../examples/README-ORDERSYSTEM.md) - ç”Ÿäº§çº§ç¤ºä¾‹

---

<div align="center">

**ğŸš€ Catga - æ€§èƒ½ç»è¿‡å…¨é¢éªŒè¯çš„ CQRS æ¡†æ¶**

**44 ä¸ªåŸºå‡†æµ‹è¯• Â· å…¨éƒ¨é€šè¿‡ Â· ç”Ÿäº§å°±ç»ª**

[GitHub](https://github.com/catga/catga) Â· [æ–‡æ¡£](INDEX.md) Â· [ç¤ºä¾‹](../examples/)

</div>

