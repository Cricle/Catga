using Catga.Core;
using Catga.Flow;
using MemoryPack;
using OrderSystem.Api.Domain;
using Catga.Abstractions;

namespace OrderSystem.Api.Messages;

/// <summary>
/// Create order command (with auto-generated debug capture via Source Generator)
/// Demonstrates: CQRS pattern, automatic error handling, rollback mechanism
/// </summary>
[MemoryPackable]
public partial record CreateOrderCommand(
    string CustomerId,
    List<OrderItem> Items,
    string ShippingAddress,
    string PaymentMethod
) : IRequest<OrderCreatedResult>;  // MessageId will be auto-generated by Source Generator

/// <summary>
/// Create order command using Flow orchestration for automatic compensation.
/// Demonstrates: Zero-cost saga pattern with automatic rollback on failure.
///
/// Flow steps with automatic compensation:
/// 1. Check Inventory (read-only, no compensation)
/// 2. Create Order â†’ Compensation: Mark order as failed
/// 3. Reserve Inventory â†’ Compensation: Release inventory
/// 4. Process Payment â†’ Compensation: Refund payment
/// 5. Confirm Order (final step, no compensation)
///
/// On any failure, compensations execute in reverse order automatically.
/// </summary>
[MemoryPackable]
public partial record CreateOrderFlowCommand(
    string CustomerId,
    List<OrderItem> Items,
    string ShippingAddress,
    string PaymentMethod
) : IRequest<OrderCreatedResult>;

[MemoryPackable]
public partial record OrderCreatedResult(
    string OrderId,
    decimal TotalAmount,
    DateTime CreatedAt
);

/// <summary>
/// Cancel order command
/// Demonstrates: Simple command handling, state transitions
/// </summary>
[MemoryPackable]
public partial record CancelOrderCommand(
    string OrderId,
    string Reason
) : IRequest;  // MessageId will be auto-generated by Source Generator

/// <summary>
/// Get order query
/// Demonstrates: Query pattern, read model
/// </summary>
[MemoryPackable]
public partial record GetOrderQuery(
    string OrderId
) : IRequest<Order?>;  // MessageId will be auto-generated by Source Generator

// ===== Flow æœåŠ¡ç¼–æ’ç¤ºä¾‹ =====
// ä½¿ç”¨ [Compensation] å±æ€§æ ‡è®°å‘½ä»¤ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

/// <summary>
/// Reserve inventory command with automatic compensation
/// </summary>
[MemoryPackable]
[Compensation(typeof(ReleaseInventoryCommand))]
public partial record ReserveInventoryCommand(
    string OrderId,
    List<OrderItem> Items
) : IRequest<ReserveInventoryResult>;

[MemoryPackable]
public partial record ReserveInventoryResult(string ReservationId);

/// <summary>
/// Release inventory command (compensation for ReserveInventory)
/// </summary>
[MemoryPackable]
public partial record ReleaseInventoryCommand(string ReservationId) : IRequest;

/// <summary>
/// Process payment command with automatic compensation
/// </summary>
[MemoryPackable]
[Compensation(typeof(RefundPaymentCommand))]
public partial record ProcessPaymentCommand(
    string OrderId,
    decimal Amount,
    string PaymentMethod
) : IRequest<ProcessPaymentResult>;

[MemoryPackable]
public partial record ProcessPaymentResult(string PaymentId);

/// <summary>
/// Refund payment command (compensation for ProcessPayment)
/// </summary>
[MemoryPackable]
public partial record RefundPaymentCommand(string PaymentId) : IRequest;

// ===== æ‰©å±•æŒ‡å— =====
// ğŸ’¡ å¦‚ä½•ä½¿ç”¨ Flow æœåŠ¡ç¼–æ’ï¼Ÿ
//
// 1. å®šä¹‰å‘½ä»¤å¹¶æ ‡è®°è¡¥å¿ï¼š
//    [Compensation(typeof(CancelOrderCommand))]
//    public partial record CreateOrderCommand(...) : IRequest<OrderCreatedResult>;
//
// 2. åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ Flowï¼š
//    await using var flow = mediator.BeginFlow("CreateOrder");
//    var order = await flow.ExecuteAsync<CreateOrderCommand, OrderCreatedResult>(cmd, ct);
//    var stock = await flow.ExecuteAsync<ReserveInventoryCommand, ReserveInventoryResult>(cmd, ct);
//    var payment = await flow.ExecuteAsync<ProcessPaymentCommand, ProcessPaymentResult>(cmd, ct);
//    flow.Commit(); // æˆåŠŸï¼Œä¸æ‰§è¡Œè¡¥å¿
//    // ä»»ä½•æ­¥éª¤å¤±è´¥ï¼ŒDispose æ—¶è‡ªåŠ¨é€†åºæ‰§è¡Œè¡¥å¿
//
// 3. æˆ–è€…ä½¿ç”¨ RunFlowAsyncï¼š
//    var result = await mediator.RunFlowAsync("CreateOrder", async flow => {
//        var order = await flow.ExecuteAsync<CreateOrderCommand, OrderCreatedResult>(cmd, ct);
//        return order.Value;
//    });
//
// Source Generator ä¼šè‡ªåŠ¨ç”Ÿæˆ ICompensatable å®ç°ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ï¼
