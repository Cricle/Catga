using Catga.Core;
using MemoryPack;
using OrderSystem.Api.Domain;
using Catga.Abstractions;

namespace OrderSystem.Api.Messages;

/// <summary>
/// Order created event
/// Published when an order is successfully created
/// Demonstrates: Event-driven architecture, pub/sub pattern
/// </summary>
[MemoryPackable]
public partial record OrderCreatedEvent(
    string OrderId,
    string CustomerId,
    List<OrderItem> Items,
    decimal TotalAmount,
    DateTime CreatedAt
) : IEvent;  // MessageId will be auto-generated by Source Generator

/// <summary>
/// Order cancelled event
/// Published when an order is cancelled
/// </summary>
[MemoryPackable]
public partial record OrderCancelledEvent(
    string OrderId,
    string Reason,
    DateTime CancelledAt
) : IEvent;  // MessageId will be auto-generated by Source Generator

/// <summary>
/// Order failed event (for rollback scenarios)
/// Published when order creation fails after some steps completed
/// Demonstrates: Compensation pattern, failure handling
/// </summary>
[MemoryPackable]
public partial record OrderFailedEvent(
    string OrderId,
    string CustomerId,
    string Reason,
    DateTime FailedAt
) : IEvent;  // MessageId will be auto-generated by Source Generator

// ===== æ‰©å±•æŒ‡å— =====
// ğŸ’¡ å¦‚ä½•æ·»åŠ æ–°äº‹ä»¶ï¼Ÿ
//
// 1. å®šä¹‰äº‹ä»¶ Recordï¼š
//    [MemoryPackable]
//    public partial record MyEvent(string Data) : IEvent;
//
// 2. åœ¨ Handler ä¸­å‘å¸ƒäº‹ä»¶ï¼š
//    await _mediator.PublishAsync(new MyEvent("data"), cancellationToken);
//
// 3. åˆ›å»ºäº‹ä»¶å¤„ç†å™¨ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨æ³¨å†Œï¼‰ï¼š
//    public class MyEventHandler : IEventHandler<MyEvent>
//    {
//        public async Task HandleAsync(MyEvent notification, CancellationToken ct)
//        {
//            // å¤„ç†äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼šå‘é€é€šçŸ¥ã€æ›´æ–°ç»Ÿè®¡ï¼‰
//        }
//    }
//
// ä¸€ä¸ªäº‹ä»¶å¯ä»¥æœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œå®ƒä»¬ä¼šå¹¶å‘æ‰§è¡Œï¼
//
// ç¤ºä¾‹ï¼šæ·»åŠ è®¢å•ç¡®è®¤äº‹ä»¶
// [MemoryPackable]
// public partial record OrderConfirmedEvent(
//     string OrderId,
//     DateTime ConfirmedAt
// ) : IEvent;
//
// // Handler 1: å‘é€ç¡®è®¤é‚®ä»¶
// public class SendConfirmationEmailHandler : IEventHandler<OrderConfirmedEvent>
// {
//     public Task HandleAsync(OrderConfirmedEvent e, CancellationToken ct)
//     {
//         // å‘é€é‚®ä»¶é€»è¾‘
//         return Task.CompletedTask;
//     }
// }
//
// // Handler 2: æ›´æ–°ç»Ÿè®¡
// public class UpdateStatsHandler : IEventHandler<OrderConfirmedEvent>
// {
//     public Task HandleAsync(OrderConfirmedEvent e, CancellationToken ct)
//     {
//         // æ›´æ–°ç»Ÿè®¡é€»è¾‘
//         return Task.CompletedTask;
//     }
// }
