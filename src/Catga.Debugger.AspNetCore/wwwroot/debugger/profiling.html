<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catga ÊÄßËÉΩÂàÜÊûê</title>
    <script src="/lib/tailwind.js"></script>
    <script defer src="/lib/alpine.min.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="profilingApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-gray-900">üî• ÊÄßËÉΩÂàÜÊûê</h1>
                        <a href="/debugger/" class="text-sm text-blue-600 hover:text-blue-800">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button @click="refreshData()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            üîÑ Âà∑Êñ∞
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
            <!-- Tabs -->
            <div class="bg-white shadow-sm rounded-lg">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button @click="activeTab = 'slow-queries'"
                                :class="activeTab === 'slow-queries' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="px-6 py-3 border-b-2 font-medium text-sm">
                            üêå ÊÖ¢Êü•ËØ¢
                        </button>
                        <button @click="activeTab = 'hot-spots'"
                                :class="activeTab === 'hot-spots' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="px-6 py-3 border-b-2 font-medium text-sm">
                            üî• ÁÉ≠ÁÇπÂàÜÊûê
                        </button>
                        <button @click="activeTab = 'gc-analysis'"
                                :class="activeTab === 'gc-analysis' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="px-6 py-3 border-b-2 font-medium text-sm">
                            ‚ôªÔ∏è GC ÂàÜÊûê
                        </button>
                        <button @click="activeTab = 'flame-graph'"
                                :class="activeTab === 'flame-graph' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="px-6 py-3 border-b-2 font-medium text-sm">
                            üìä ÁÅ´ÁÑ∞Âõæ
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Slow Queries Tab -->
                    <div x-show="activeTab === 'slow-queries'">
                        <div class="mb-4 flex items-center space-x-4">
                            <label class="text-sm font-medium text-gray-700">ÈòàÂÄº (ms):</label>
                            <input x-model.number="slowQueryThreshold" type="number" min="100" step="100"
                                   class="px-3 py-1 border border-gray-300 rounded-md w-32">
                            <button @click="loadSlowQueries()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Â∫îÁî®
                            </button>
                        </div>

                        <div x-show="slowQueries.length === 0" class="text-center py-8 text-gray-500">
                            ÊöÇÊó†ÊÖ¢Êü•ËØ¢Êï∞ÊçÆ
                        </div>

                        <div x-show="slowQueries.length > 0" class="space-y-3">
                            <template x-for="query in slowQueries" :key="query.correlationId">
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h3 class="text-sm font-medium text-gray-900" x-text="query.requestType"></h3>
                                            <p class="text-xs text-gray-500 mt-1">
                                                Correlation: <code class="bg-gray-100 px-1 rounded" x-text="query.correlationId.substring(0,16) + '...'"></code>
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold" :class="query.slownessFactor > 5 ? 'text-red-600' : query.slownessFactor > 2 ? 'text-orange-500' : 'text-yellow-600'">
                                                <span x-text="Math.round(query.duration / 10000)"></span>ms
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                <span x-text="query.slownessFactor.toFixed(1)"></span>x slower
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex items-center justify-between">
                                        <div class="text-xs text-gray-500">
                                            Ê£ÄÊµãÊó∂Èó¥: <span x-text="new Date(query.detectedAt).toLocaleString()"></span>
                                        </div>
                                        <a :href="'/debugger/replay-player.html?correlationId=' + query.correlationId"
                                           class="text-xs text-blue-600 hover:text-blue-800">
                                            üé¨ Êü•ÁúãÂõûÊîæ
                                        </a>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Hot Spots Tab -->
                    <div x-show="activeTab === 'hot-spots'">
                        <div x-show="hotSpots.length === 0" class="text-center py-8 text-gray-500">
                            ÊöÇÊó†ÁÉ≠ÁÇπÊï∞ÊçÆ
                        </div>

                        <div x-show="hotSpots.length > 0" class="space-y-3">
                            <template x-for="(spot, index) in hotSpots" :key="index">
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-lg font-bold text-gray-400">#<span x-text="index + 1"></span></span>
                                                <h3 class="text-sm font-medium text-gray-900" x-text="spot.methodName"></h3>
                                            </div>
                                            <div class="mt-2 grid grid-cols-3 gap-4 text-sm">
                                                <div>
                                                    <div class="text-gray-500">ÊÄªËÄóÊó∂</div>
                                                    <div class="font-semibold" x-text="Math.round(spot.totalTime / 10000) + 'ms'"></div>
                                                </div>
                                                <div>
                                                    <div class="text-gray-500">Ë∞ÉÁî®Ê¨°Êï∞</div>
                                                    <div class="font-semibold" x-text="spot.callCount"></div>
                                                </div>
                                                <div>
                                                    <div class="text-gray-500">Âπ≥ÂùáËÄóÊó∂</div>
                                                    <div class="font-semibold" x-text="Math.round(spot.averageTime / 10000) + 'ms'"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-3xl" :class="index < 3 ? 'text-red-500' : 'text-orange-400'">
                                                üî•
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- GC Analysis Tab -->
                    <div x-show="activeTab === 'gc-analysis'">
                        <div x-show="!gcAnalysis" class="text-center py-8 text-gray-500">
                            Âä†ËΩΩ‰∏≠...
                        </div>

                        <div x-show="gcAnalysis" class="space-y-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4">
                                    <div class="text-sm text-green-800 font-medium">Gen 0 ÂõûÊî∂</div>
                                    <div class="text-2xl font-bold text-green-900 mt-1" x-text="gcAnalysis?.gen0Collections || 0"></div>
                                </div>
                                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-200 rounded-lg p-4">
                                    <div class="text-sm text-yellow-800 font-medium">Gen 1 ÂõûÊî∂</div>
                                    <div class="text-2xl font-bold text-yellow-900 mt-1" x-text="gcAnalysis?.gen1Collections || 0"></div>
                                </div>
                                <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-4">
                                    <div class="text-sm text-orange-800 font-medium">Gen 2 ÂõûÊî∂</div>
                                    <div class="text-2xl font-bold text-orange-900 mt-1" x-text="gcAnalysis?.gen2Collections || 0"></div>
                                </div>
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
                                    <div class="text-sm text-blue-800 font-medium">ÊÄªÂÜÖÂ≠ò</div>
                                    <div class="text-2xl font-bold text-blue-900 mt-1" x-text="formatBytes(gcAnalysis?.totalMemoryBytes || 0)"></div>
                                </div>
                            </div>

                            <div x-show="gcAnalysis?.isHighPressure" class="bg-red-50 border-l-4 border-red-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800">‚ö†Ô∏è È´ò GC ÂéãÂäõÊ£ÄÊµã</h3>
                                        <p class="mt-1 text-sm text-red-700">Á≥ªÁªüÊ£ÄÊµãÂà∞È¢ëÁπÅÁöÑ Gen2 ÂûÉÂúæÂõûÊî∂ÔºåËøôÂèØËÉΩÂΩ±ÂìçÊÄßËÉΩ„ÄÇÂª∫ËÆÆÊ£ÄÊü•ÂÜÖÂ≠òÂàÜÈÖçÂíåÂØπË±°ÁîüÂëΩÂë®Êúü„ÄÇ</p>
                                    </div>
                                </div>
                            </div>

                            <div class="text-xs text-gray-500 text-right">
                                Êõ¥Êñ∞Êó∂Èó¥: <span x-text="gcAnalysis ? new Date(gcAnalysis.analyzedAt).toLocaleString() : ''"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Flame Graph Tab -->
                    <div x-show="activeTab === 'flame-graph'">
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700">ÈÄâÊã©Ê∂àÊÅØÊµÅ:</label>
                            <select x-model="selectedFlowForFlameGraph" @change="loadFlameGraph()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">-- ÈÄâÊã©‰∏Ä‰∏™ÊµÅ --</option>
                                <template x-for="query in slowQueries" :key="query.correlationId">
                                    <option :value="query.correlationId"
                                            x-text="`${query.requestType} (${query.correlationId.substring(0,8)}...)`">
                                    </option>
                                </template>
                            </select>
                        </div>

                        <div x-show="!selectedFlowForFlameGraph" class="text-center py-8 text-gray-500">
                            ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê∂àÊÅØÊµÅ‰ª•Êü•ÁúãÁÅ´ÁÑ∞Âõæ
                        </div>

                        <div x-show="selectedFlowForFlameGraph && !flameGraphData" class="text-center py-8 text-gray-500">
                            Âä†ËΩΩ‰∏≠...
                        </div>

                        <div x-show="flameGraphData" class="space-y-4">
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                                <p class="text-sm text-blue-800">
                                    ‚ÑπÔ∏è ÁÅ´ÁÑ∞ÂõæÂÆåÊï¥ÂèØËßÜÂåñÈúÄË¶Å D3.js Â∫ì„ÄÇÂΩìÂâç‰ªÖÊòæÁ§∫ÂéüÂßãÊï∞ÊçÆ„ÄÇ
                                    Êé®Ëçê‰ΩøÁî®‰∏ì‰∏öÂ∑•ÂÖ∑Â¶Ç Speedscope Êàñ FlameGraph.com Êü•Áúã„ÄÇ
                                </p>
                            </div>

                            <div x-show="flameGraphData" class="bg-white border border-gray-200 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-900 mb-3">ÁÅ´ÁÑ∞ÂõæÊï∞ÊçÆ</h3>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <div class="text-xs text-gray-500">ÊÄªÊ†∑Êú¨Êï∞</div>
                                        <div class="text-lg font-semibold" x-text="flameGraphData?.totalSamples || 0"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500">ÊÄªÊó∂Èó¥ (ms)</div>
                                        <div class="text-lg font-semibold" x-text="Math.round(flameGraphData?.totalTimeMs || 0)"></div>
                                    </div>
                                </div>
                                <pre class="text-xs bg-gray-50 p-3 rounded overflow-auto max-h-96" x-text="JSON.stringify(flameGraphData, null, 2)"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function profilingApp() {
            return {
                activeTab: 'slow-queries',
                slowQueryThreshold: 1000,
                slowQueries: [],
                hotSpots: [],
                gcAnalysis: null,
                selectedFlowForFlameGraph: '',
                flameGraphData: null,

                async init() {
                    await this.refreshData();
                },

                async refreshData() {
                    await Promise.all([
                        this.loadSlowQueries(),
                        this.loadHotSpots(),
                        this.loadGcAnalysis()
                    ]);
                },

                async loadSlowQueries() {
                    try {
                        const response = await fetch(`/debug-api/profiling/slow-queries?thresholdMs=${this.slowQueryThreshold}&topN=10`);
                        if (response.ok) {
                            this.slowQueries = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load slow queries:', error);
                    }
                },

                async loadHotSpots() {
                    try {
                        const response = await fetch('/debug-api/profiling/hot-spots?topN=10');
                        if (response.ok) {
                            this.hotSpots = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load hot spots:', error);
                    }
                },

                async loadGcAnalysis() {
                    try {
                        const response = await fetch('/debug-api/profiling/gc-analysis');
                        if (response.ok) {
                            this.gcAnalysis = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load GC analysis:', error);
                    }
                },

                async loadFlameGraph() {
                    if (!this.selectedFlowForFlameGraph) return;

                    try {
                        const response = await fetch(`/debug-api/profiling/flame-graph/${this.selectedFlowForFlameGraph}?type=cpu`);
                        if (response.ok) {
                            this.flameGraphData = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load flame graph:', error);
                    }
                },

                formatBytes(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>

