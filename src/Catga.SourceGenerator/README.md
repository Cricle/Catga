# Catga æºç”Ÿæˆå™¨

## ğŸ“– ç®€ä»‹

Catga æºç”Ÿæˆå™¨åœ¨**ç¼–è¯‘æ—¶**è‡ªåŠ¨å‘ç°å¹¶ç”Ÿæˆ Handler æ³¨å†Œä»£ç ï¼Œå®ç°ï¼š
- âœ¨ **é›¶æ‰‹åŠ¨é…ç½®** - å®ç°æ¥å£å³è‡ªåŠ¨æ³¨å†Œ
- ğŸš€ **ç¼–è¯‘æ—¶ç”Ÿæˆ** - é›¶è¿è¡Œæ—¶å¼€é”€
- ğŸ¯ **100% AOT å…¼å®¹** - æ— åå°„ï¼Œå®Œå…¨é™æ€åŒ–
- ğŸ’ **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶éªŒè¯

## ğŸ“‹ æºç”Ÿæˆå™¨åˆ—è¡¨

Catga åŒ…å«ä»¥ä¸‹æºç”Ÿæˆå™¨ï¼Œå®ç°é›¶åå°„ã€AOTå…¼å®¹çš„ä»£ç ç”Ÿæˆï¼š

### æ ¸å¿ƒç”Ÿæˆå™¨ï¼ˆ7ä¸ªï¼‰

1. **UnifiedRegistrationGenerator** - ç»Ÿä¸€æ³¨å†Œ Handler å’Œ Serviceï¼ˆåˆå¹¶äº†åŸ HandlerRegistrationGenerator å’Œ ServiceRegistrationGeneratorï¼‰
2. **UnifiedModuleInitializerGenerator** - ç»Ÿä¸€åˆå§‹åŒ–äº‹ä»¶ç±»å‹å’Œæ‰¹å¤„ç†é…ç½®ï¼ˆåˆå¹¶äº†åŸ EventTypeRegistryGenerator å’Œ MediatorBatchProfilesGeneratorï¼‰
3. **ActivityTagProviderGenerator** - ç”Ÿæˆåˆ†å¸ƒå¼è¿½è¸ªæ ‡ç­¾æä¾›å™¨
4. **EndpointRegistrationGenerator** - è‡ªåŠ¨æ³¨å†Œ HTTP ç«¯ç‚¹
5. **EventRouterGenerator** - ç”Ÿæˆé›¶åå°„äº‹ä»¶è·¯ç”±å™¨
6. **FlowDslRegistrationGenerator** - è‡ªåŠ¨æ³¨å†Œ Flow DSL é…ç½®
7. **MessageIdGenerator** - è‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯ ID

### å®éªŒæ€§ç”Ÿæˆå™¨ï¼ˆ1ä¸ªï¼‰

10. **FlowStateChangeTrackingGenerator** - Flow çŠ¶æ€å˜æ›´è·Ÿè¸ªï¼ˆå®éªŒæ€§ï¼‰
    - ä¸ºæ ‡è®°äº† `[FlowState]` çš„ç±»è‡ªåŠ¨ç”ŸæˆçŠ¶æ€å˜æ›´è·Ÿè¸ª
    - ç”Ÿæˆ `HasChanges`ã€`GetChangedMask()`ã€`ClearChanges()` ç­‰æ–¹æ³•
    - ç›®å‰ä¸»è¦ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨éœ€è°¨æ…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ å¼•ç”¨

```xml
<ItemGroup>
  <ProjectReference Include="Catga.SourceGenerator.csproj"
                    OutputItemType="Analyzer"
                    ReferenceOutputAssembly="false" />
</ItemGroup>
```

### 2. ç¼–å†™ Handler

```csharp
// ğŸ¯ æ— éœ€ä»»ä½•ç‰¹æ€§æ ‡è®°ï¼Œè‡ªåŠ¨å‘ç°ï¼
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse>
{
    public Task<CatgaResult<UserResponse>> HandleAsync(
        CreateUserCommand request,
        CancellationToken cancellationToken = default)
    {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

### 3. æ³¨å†Œ Handler å’Œ Service

```csharp
// âœ¨ ä¸€è¡Œä»£ç ï¼Œè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ Handler å’Œ Service
builder.Services.AddCatgaServices();
```

## ğŸ¯ å·¥ä½œåŸç†

### ç¼–è¯‘æ—¶

æºç”Ÿæˆå™¨ä¼šæ‰«ææ‰€æœ‰å®ç°äº†ä»¥ä¸‹æ¥å£çš„ç±»ï¼š
- `IRequestHandler<TRequest, TResponse>`
- `IRequestHandler<TRequest>`
- `IEventHandler<TEvent>`
- `IPipelineBehavior<TRequest, TResponse>`
- `IProjection`
- `IEventUpgrader`
- æ ‡è®°äº† `[CatgaService]` çš„æœåŠ¡ç±»

ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹ï¼š

```csharp
// <auto-generated/>
namespace Catga.DependencyInjection;

public static class CatgaUnifiedRegistrations
{
    public static IServiceCollection AddCatgaServices(this IServiceCollection services)
    {
        // Request Handlers
        services.AddScoped<IRequestHandler<CreateUserCommand, UserResponse>, CreateUserHandler>();
        services.AddScoped<IRequestHandler<GetUserQuery, UserResponse>, GetUserHandler>();

        // Event Handlers
        services.AddScoped<IEventHandler<UserCreatedEvent>, UserCreatedEventHandler>();

        // Services
        services.AddScoped<IUserRepository, UserRepository>();
        services.AddScoped<UserRepository>();

        return services;
    }
}
```

### è¿è¡Œæ—¶

è°ƒç”¨ `AddCatgaServices()` æ—¶ï¼Œç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„ä»£ç ï¼Œ**é›¶åå°„ã€é›¶æ‰«æ**ï¼

## ğŸ¨ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ

```csharp
using Catga;

// Singletonï¼ˆå•ä¾‹ï¼‰
[CatgaLifetime(ServiceLifetime.Singleton)]
public class CachedDataHandler : IRequestHandler<GetCachedDataQuery, DataResponse>
{
    // å•ä¾‹ Handlerï¼Œé€‚åˆæ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨çš„åœºæ™¯
}

// Transientï¼ˆæ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹ï¼‰
[CatgaLifetime(ServiceLifetime.Transient)]
public class TempHandler : IRequestHandler<TempCommand, TempResponse>
{
    // ç¬æ€ Handlerï¼Œæ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°å®ä¾‹
}

// Scopedï¼ˆé»˜è®¤ï¼Œä½œç”¨åŸŸå†…å•ä¾‹ï¼‰
public class OrderHandler : IRequestHandler<CreateOrderCommand, OrderResponse>
{
    // é»˜è®¤ Scopedï¼Œä¸€æ¬¡è¯·æ±‚å†…å…±äº«å®ä¾‹
}
```

### 2. ç¦ç”¨è‡ªåŠ¨æ³¨å†Œ

```csharp
using Catga;

// æ‰‹åŠ¨æ³¨å†Œï¼ˆä¸ä½¿ç”¨æºç”Ÿæˆå™¨ï¼‰
[CatgaIgnore]
public class ManualHandler : IRequestHandler<ManualCommand, ManualResponse>
{
    // éœ€è¦æ‰‹åŠ¨æ³¨å†Œ: services.AddScoped<IRequestHandler<ManualCommand, ManualResponse>, ManualHandler>();
}
```

**ä½¿ç”¨åœºæ™¯**:
- éœ€è¦å¤æ‚çš„æ³¨å†Œé€»è¾‘
- éœ€è¦æ¡ä»¶æ³¨å†Œ
- éœ€è¦è‡ªå®šä¹‰å·¥å‚æ–¹æ³•

### 3. æ³¨å†Œ Service

```csharp
using Catga;

// è‡ªåŠ¨æ³¨å†Œ Serviceï¼ˆå¸¦æ¥å£ï¼‰
[CatgaService(ServiceType = typeof(IUserRepository))]
public class UserRepository : IUserRepository
{
    // ä¼šç”Ÿæˆä¸¤ä¸ªæ³¨å†Œï¼š
    // services.AddScoped<IUserRepository, UserRepository>();
    // services.AddScoped<UserRepository>();
}

// è‡ªåŠ¨æ³¨å†Œ Serviceï¼ˆæ— æ¥å£ï¼‰
[CatgaService]
public class OrderStore
{
    // åªæ³¨å†Œå…·ä½“ç±»å‹ï¼š
    // services.AddScoped<OrderStore>();
}

// è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ
[CatgaService(Lifetime = ServiceLifetime.Singleton)]
public class CacheService
{
    // å•ä¾‹æœåŠ¡
}
```

### 4. ç»„åˆä½¿ç”¨

```csharp
// âœ¨ è‡ªåŠ¨æ³¨å†Œï¼ˆæºç”Ÿæˆå™¨ï¼‰
services.AddCatgaServices();

// ğŸ”§ æ‰‹åŠ¨æ³¨å†Œç‰¹æ®Š Handler
services.AddSingleton<IRequestHandler<SpecialCommand, SpecialResponse>>(sp =>
    new SpecialHandler(sp.GetRequiredService<ISpecialDependency>()));
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹å¼ | å¯åŠ¨æ—¶é—´ | è¿è¡Œæ—¶å¼€é”€ | AOT å…¼å®¹ |
|------|---------|----------|---------|
| **æºç”Ÿæˆå™¨** | ~50ms | 0 | âœ… 100% |
| åå°„æ‰«æ | ~500ms | é«˜ | âŒ ä¸å…¼å®¹ |
| æ‰‹åŠ¨æ³¨å†Œ | ~50ms | 0 | âœ… 100% |

## ğŸ” è°ƒè¯•ç”Ÿæˆçš„ä»£ç 

ç”Ÿæˆçš„ä»£ç ä½äºï¼š
```
obj/Debug/net9.0/generated/Catga.SourceGenerator/Catga.SourceGenerator.UnifiedRegistrationGenerator/CatgaUnifiedRegistrations.g.cs
obj/Debug/net9.0/generated/Catga.SourceGenerator/Catga.SourceGenerator.UnifiedModuleInitializerGenerator/CatgaGenerated.UnifiedModuleInitializer.g.cs
```

æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç ï¼š
```bash
# ç¼–è¯‘åæŸ¥çœ‹
cat obj/Debug/net9.0/generated/Catga.SourceGenerator/Catga.SourceGenerator.UnifiedRegistrationGenerator/CatgaUnifiedRegistrations.g.cs
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä¿æŒ Handler ç®€å•

```csharp
// âœ… å¥½ï¼šç®€å•ã€å•ä¸€èŒè´£
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse>
{
    private readonly IUserRepository _repository;
    private readonly ILogger<CreateUserHandler> _logger;

    public CreateUserHandler(IUserRepository repository, ILogger<CreateUserHandler> logger)
    {
        _repository = repository;
        _logger = logger;
    }

    public async Task<CatgaResult<UserResponse>> HandleAsync(CreateUserCommand cmd, CancellationToken ct)
    {
        _logger.LogInformation("Creating user: {Username}", cmd.Username);
        var user = await _repository.CreateAsync(cmd, ct);
        return CatgaResult<UserResponse>.Success(new UserResponse(user.Id, user.Username));
    }
}
```

### 2. åˆç†é€‰æ‹©ç”Ÿå‘½å‘¨æœŸ

| ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨åœºæ™¯ | æ³¨æ„äº‹é¡¹ |
|---------|---------|---------|
| **Scoped** (é»˜è®¤) | å¤§å¤šæ•°ä¸šåŠ¡é€»è¾‘ | ä¸€æ¬¡è¯·æ±‚å†…å…±äº« |
| **Singleton** | æ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨ | é¿å…çŠ¶æ€ï¼Œæ³¨æ„çº¿ç¨‹å®‰å…¨ |
| **Transient** | éœ€è¦ç‹¬ç«‹çŠ¶æ€ | æ¯æ¬¡åˆ›å»ºï¼Œå¼€é”€ç¨é«˜ |

### 3. å‘½åçº¦å®š

```csharp
// âœ… æ¨èï¼š{æ“ä½œ}{å®ä½“}Handler
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse> { }
public class GetUserHandler : IRequestHandler<GetUserQuery, UserResponse> { }
public class DeleteUserHandler : IRequestHandler<DeleteUserCommand> { }

// âœ… æ¨èï¼š{å®ä½“}{äº‹ä»¶}Handler
public class UserCreatedEventHandler : IEventHandler<UserCreatedEvent> { }
public class OrderShippedEventHandler : IEventHandler<OrderShippedEvent> { }
```

## ğŸ”¬ å®éªŒæ€§åŠŸèƒ½

### FlowStateChangeTrackingGenerator

ä¸º Flow çŠ¶æ€ç±»è‡ªåŠ¨ç”Ÿæˆå˜æ›´è·Ÿè¸ªåŠŸèƒ½ã€‚

**ä½¿ç”¨æ–¹æ³•ï¼š**

```csharp
using Catga.Flow;

// 1. æ ‡è®°ç±»ä¸º [FlowState] å¹¶å®ç° IFlowState
[FlowState]
public partial class OrderFlowState : IFlowState
{
    public string? FlowId { get; set; }

    // 2. ä½¿ç”¨ [FlowStateField] æ ‡è®°éœ€è¦è·Ÿè¸ªçš„å­—æ®µ
    [FlowStateField]
    private string _orderId = string.Empty;

    [FlowStateField]
    private decimal _totalAmount;

    [FlowStateField]
    private OrderStatus _status;
}
```

**ç”Ÿæˆçš„ä»£ç ï¼š**

```csharp
public partial class OrderFlowState
{
    // è‡ªåŠ¨ç”Ÿæˆçš„å±æ€§ï¼ˆå¸¦å˜æ›´è·Ÿè¸ªï¼‰
    public string OrderId
    {
        get => _orderId;
        set
        {
            if (!string.Equals(_orderId, value, StringComparison.Ordinal))
            {
                _orderId = value;
                _changedMask |= OrderIdBit;
            }
        }
    }

    public decimal TotalAmount
    {
        get => _totalAmount;
        set
        {
            if (!_totalAmount.Equals(value))
            {
                _totalAmount = value;
                _changedMask |= TotalAmountBit;
            }
        }
    }

    // IFlowState å®ç°
    public bool HasChanges => _changedMask != 0;
    public int GetChangedMask() => _changedMask;
    public bool IsFieldChanged(int fieldIndex) => (_changedMask & (1 << fieldIndex)) != 0;
    public void ClearChanges() => _changedMask = 0;
    public void MarkChanged(int fieldIndex) => _changedMask |= 1 << fieldIndex;
    public IEnumerable<string> GetChangedFieldNames() { /* ... */ }
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**

```csharp
var state = new OrderFlowState();
state.OrderId = "ORD-001";
state.TotalAmount = 99.99m;

// æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
if (state.HasChanges)
{
    // è·å–å˜æ›´çš„å­—æ®µå
    var changedFields = state.GetChangedFieldNames(); // ["OrderId", "TotalAmount"]
    
    // æ¸…é™¤å˜æ›´æ ‡è®°
    state.ClearChanges();
}
```

**æ³¨æ„äº‹é¡¹ï¼š**
- æ­¤åŠŸèƒ½ç›®å‰ä¸ºå®éªŒæ€§ï¼ŒAPI å¯èƒ½ä¼šå˜æ›´
- ä¸»è¦ç”¨äº Flow çŠ¶æ€æŒä¹…åŒ–ä¼˜åŒ–
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨éœ€å……åˆ†æµ‹è¯•

## ğŸ› å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„ Handler æ²¡æœ‰è¢«æ³¨å†Œï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. Handler æ˜¯å¦å®ç°äº† `IRequestHandler` æˆ– `IEventHandler`ï¼Ÿ
2. Handler ç±»æ˜¯å¦æ˜¯ `public`ï¼Ÿ
3. æ˜¯å¦è°ƒç”¨äº† `AddCatgaServices()`ï¼Ÿ
4. æ˜¯å¦æ ‡è®°äº† `[CatgaIgnore]`ï¼Ÿ

### Q: å¦‚ä½•æŸ¥çœ‹ç”Ÿæˆäº†å“ªäº› Handler å’Œ Serviceï¼Ÿ

A: æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ï¼š
```
obj/Debug/net9.0/generated/Catga.SourceGenerator/Catga.SourceGenerator.UnifiedRegistrationGenerator/CatgaUnifiedRegistrations.g.cs
```

### Q: æºç”Ÿæˆå™¨ä¼šå½±å“ç¼–è¯‘æ—¶é—´å—ï¼Ÿ

A: å½±å“æå°ï¼ˆ< 100msï¼‰ï¼Œå› ä¸ºæºç”Ÿæˆå™¨åªåœ¨ç¼–è¯‘æ—¶è¿è¡Œä¸€æ¬¡ã€‚

### Q: å¯ä»¥æ··åˆä½¿ç”¨è‡ªåŠ¨æ³¨å†Œå’Œæ‰‹åŠ¨æ³¨å†Œå—ï¼Ÿ

A: å¯ä»¥ï¼å…ˆè°ƒç”¨ `AddCatgaServices()`ï¼Œå†æ‰‹åŠ¨æ³¨å†Œç‰¹æ®Š Handlerã€‚

### Q: æ—§çš„ `AddCatgaHandlers()` æ–¹æ³•è¿˜èƒ½ç”¨å—ï¼Ÿ

A: å¯ä»¥ï¼Œä½†å·²æ ‡è®°ä¸º `[Obsolete]`ã€‚å»ºè®®è¿ç§»åˆ°æ–°çš„ `AddCatgaServices()` æ–¹æ³•ï¼ŒåŠŸèƒ½å®Œå…¨ç›¸åŒã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Catga å¿«é€Ÿå¼€å§‹](../../QUICK_START.md)
- [æ¶æ„è¯´æ˜](../../ARCHITECTURE.md)
- [ç¤ºä¾‹é¡¹ç›®](../../examples/)

---

**Catga æºç”Ÿæˆå™¨ - ç¼–è¯‘æ—¶é­”æ³•ï¼Œè¿è¡Œæ—¶é›¶å¼€é”€ï¼** âœ¨

