# Catga æºç”Ÿæˆå™¨

## ğŸ“– ç®€ä»‹

Catga æºç”Ÿæˆå™¨åœ¨**ç¼–è¯‘æ—¶**è‡ªåŠ¨å‘ç°å¹¶ç”Ÿæˆ Handler æ³¨å†Œä»£ç ï¼Œå®ç°ï¼š
- âœ¨ **é›¶æ‰‹åŠ¨é…ç½®** - å®ç°æ¥å£å³è‡ªåŠ¨æ³¨å†Œ
- ğŸš€ **ç¼–è¯‘æ—¶ç”Ÿæˆ** - é›¶è¿è¡Œæ—¶å¼€é”€
- ğŸ¯ **100% AOT å…¼å®¹** - æ— åå°„ï¼Œå®Œå…¨é™æ€åŒ–
- ğŸ’ **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ å¼•ç”¨

```xml
<ItemGroup>
  <ProjectReference Include="Catga.SourceGenerator.csproj"
                    OutputItemType="Analyzer"
                    ReferenceOutputAssembly="false" />
</ItemGroup>
```

### 2. ç¼–å†™ Handler

```csharp
// ğŸ¯ æ— éœ€ä»»ä½•ç‰¹æ€§æ ‡è®°ï¼Œè‡ªåŠ¨å‘ç°ï¼
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse>
{
    public Task<CatgaResult<UserResponse>> HandleAsync(
        CreateUserCommand request,
        CancellationToken cancellationToken = default)
    {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

### 3. æ³¨å†Œ Handler

```csharp
// âœ¨ ä¸€è¡Œä»£ç ï¼Œè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ Handler
builder.Services.AddGeneratedHandlers();
```

## ğŸ¯ å·¥ä½œåŸç†

### ç¼–è¯‘æ—¶

æºç”Ÿæˆå™¨ä¼šæ‰«ææ‰€æœ‰å®ç°äº†ä»¥ä¸‹æ¥å£çš„ç±»ï¼š
- `IRequestHandler<TRequest, TResponse>`
- `IRequestHandler<TRequest>`
- `IEventHandler<TEvent>`

ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹ï¼š

```csharp
// <auto-generated/>
namespace Catga.DependencyInjection;

public static class CatgaGeneratedHandlerRegistrations
{
    public static IServiceCollection AddGeneratedHandlers(this IServiceCollection services)
    {
        // Scoped lifetime handlers
        services.AddScoped<IRequestHandler<CreateUserCommand, UserResponse>, CreateUserHandler>();
        services.AddScoped<IRequestHandler<GetUserQuery, UserResponse>, GetUserHandler>();
        services.AddScoped<IEventHandler<UserCreatedEvent>, UserCreatedEventHandler>();

        return services;
    }
}
```

### è¿è¡Œæ—¶

è°ƒç”¨ `AddGeneratedHandlers()` æ—¶ï¼Œç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„ä»£ç ï¼Œ**é›¶åå°„ã€é›¶æ‰«æ**ï¼

## ğŸ¨ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ

```csharp
// Singletonï¼ˆå•ä¾‹ï¼‰
[CatgaHandler(Lifetime = HandlerLifetime.Singleton)]
public class CachedDataHandler : IRequestHandler<GetCachedDataQuery, DataResponse>
{
    // å•ä¾‹ Handlerï¼Œé€‚åˆæ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨çš„åœºæ™¯
}

// Transientï¼ˆæ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹ï¼‰
[CatgaHandler(Lifetime = HandlerLifetime.Transient)]
public class TempHandler : IRequestHandler<TempCommand, TempResponse>
{
    // ç¬æ€ Handlerï¼Œæ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°å®ä¾‹
}

// Scopedï¼ˆé»˜è®¤ï¼Œä½œç”¨åŸŸå†…å•ä¾‹ï¼‰
public class OrderHandler : IRequestHandler<CreateOrderCommand, OrderResponse>
{
    // é»˜è®¤ Scopedï¼Œä¸€æ¬¡è¯·æ±‚å†…å…±äº«å®ä¾‹
}
```

### 2. ç¦ç”¨è‡ªåŠ¨æ³¨å†Œ

```csharp
// æ‰‹åŠ¨æ³¨å†Œï¼ˆä¸ä½¿ç”¨æºç”Ÿæˆå™¨ï¼‰
[CatgaHandler(AutoRegister = false)]
public class ManualHandler : IRequestHandler<ManualCommand, ManualResponse>
{
    // éœ€è¦æ‰‹åŠ¨æ³¨å†Œ: services.AddScoped<IRequestHandler<ManualCommand, ManualResponse>, ManualHandler>();
}
```

**ä½¿ç”¨åœºæ™¯**:
- éœ€è¦å¤æ‚çš„æ³¨å†Œé€»è¾‘
- éœ€è¦æ¡ä»¶æ³¨å†Œ
- éœ€è¦è‡ªå®šä¹‰å·¥å‚æ–¹æ³•

### 3. ç»„åˆä½¿ç”¨

```csharp
// âœ¨ è‡ªåŠ¨æ³¨å†Œï¼ˆæºç”Ÿæˆå™¨ï¼‰
services.AddGeneratedHandlers();

// ğŸ”§ æ‰‹åŠ¨æ³¨å†Œç‰¹æ®Š Handler
services.AddSingleton<IRequestHandler<SpecialCommand, SpecialResponse>>(sp =>
    new SpecialHandler(sp.GetRequiredService<ISpecialDependency>()));
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹å¼ | å¯åŠ¨æ—¶é—´ | è¿è¡Œæ—¶å¼€é”€ | AOT å…¼å®¹ |
|------|---------|----------|---------|
| **æºç”Ÿæˆå™¨** | ~50ms | 0 | âœ… 100% |
| åå°„æ‰«æ | ~500ms | é«˜ | âŒ ä¸å…¼å®¹ |
| æ‰‹åŠ¨æ³¨å†Œ | ~50ms | 0 | âœ… 100% |

## ğŸ” è°ƒè¯•ç”Ÿæˆçš„ä»£ç 

ç”Ÿæˆçš„ä»£ç ä½äºï¼š
```
obj/Debug/net9.0/generated/Catga.SourceGenerator/CatgaHandlerGenerator/CatgaGeneratedHandlerRegistrations.g.cs
```

æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç ï¼š
```bash
# ç¼–è¯‘åæŸ¥çœ‹
cat obj/Debug/net9.0/generated/Catga.SourceGenerator/CatgaHandlerGenerator/CatgaGeneratedHandlerRegistrations.g.cs
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä¿æŒ Handler ç®€å•

```csharp
// âœ… å¥½ï¼šç®€å•ã€å•ä¸€èŒè´£
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse>
{
    private readonly IUserRepository _repository;
    private readonly ILogger<CreateUserHandler> _logger;

    public CreateUserHandler(IUserRepository repository, ILogger<CreateUserHandler> logger)
    {
        _repository = repository;
        _logger = logger;
    }

    public async Task<CatgaResult<UserResponse>> HandleAsync(CreateUserCommand cmd, CancellationToken ct)
    {
        _logger.LogInformation("Creating user: {Username}", cmd.Username);
        var user = await _repository.CreateAsync(cmd, ct);
        return CatgaResult<UserResponse>.Success(new UserResponse(user.Id, user.Username));
    }
}
```

### 2. åˆç†é€‰æ‹©ç”Ÿå‘½å‘¨æœŸ

| ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨åœºæ™¯ | æ³¨æ„äº‹é¡¹ |
|---------|---------|---------|
| **Scoped** (é»˜è®¤) | å¤§å¤šæ•°ä¸šåŠ¡é€»è¾‘ | ä¸€æ¬¡è¯·æ±‚å†…å…±äº« |
| **Singleton** | æ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨ | é¿å…çŠ¶æ€ï¼Œæ³¨æ„çº¿ç¨‹å®‰å…¨ |
| **Transient** | éœ€è¦ç‹¬ç«‹çŠ¶æ€ | æ¯æ¬¡åˆ›å»ºï¼Œå¼€é”€ç¨é«˜ |

### 3. å‘½åçº¦å®š

```csharp
// âœ… æ¨èï¼š{æ“ä½œ}{å®ä½“}Handler
public class CreateUserHandler : IRequestHandler<CreateUserCommand, UserResponse> { }
public class GetUserHandler : IRequestHandler<GetUserQuery, UserResponse> { }
public class DeleteUserHandler : IRequestHandler<DeleteUserCommand> { }

// âœ… æ¨èï¼š{å®ä½“}{äº‹ä»¶}Handler
public class UserCreatedEventHandler : IEventHandler<UserCreatedEvent> { }
public class OrderShippedEventHandler : IEventHandler<OrderShippedEvent> { }
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„ Handler æ²¡æœ‰è¢«æ³¨å†Œï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. Handler æ˜¯å¦å®ç°äº† `IRequestHandler` æˆ– `IEventHandler`ï¼Ÿ
2. Handler ç±»æ˜¯å¦æ˜¯ `public`ï¼Ÿ
3. æ˜¯å¦è°ƒç”¨äº† `AddGeneratedHandlers()`ï¼Ÿ
4. æ˜¯å¦è®¾ç½®äº† `AutoRegister = false`ï¼Ÿ

### Q: å¦‚ä½•æŸ¥çœ‹ç”Ÿæˆäº†å“ªäº› Handlerï¼Ÿ

A: æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ï¼š
```
obj/Debug/net9.0/generated/Catga.SourceGenerator/CatgaHandlerGenerator/CatgaGeneratedHandlerRegistrations.g.cs
```

### Q: æºç”Ÿæˆå™¨ä¼šå½±å“ç¼–è¯‘æ—¶é—´å—ï¼Ÿ

A: å½±å“æå°ï¼ˆ< 100msï¼‰ï¼Œå› ä¸ºæºç”Ÿæˆå™¨åªåœ¨ç¼–è¯‘æ—¶è¿è¡Œä¸€æ¬¡ã€‚

### Q: å¯ä»¥æ··åˆä½¿ç”¨è‡ªåŠ¨æ³¨å†Œå’Œæ‰‹åŠ¨æ³¨å†Œå—ï¼Ÿ

A: å¯ä»¥ï¼å…ˆè°ƒç”¨ `AddGeneratedHandlers()`ï¼Œå†æ‰‹åŠ¨æ³¨å†Œç‰¹æ®Š Handlerã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Catga å¿«é€Ÿå¼€å§‹](../../QUICK_START.md)
- [æ¶æ„è¯´æ˜](../../ARCHITECTURE.md)
- [ç¤ºä¾‹é¡¹ç›®](../../examples/)

---

**Catga æºç”Ÿæˆå™¨ - ç¼–è¯‘æ—¶é­”æ³•ï¼Œè¿è¡Œæ—¶é›¶å¼€é”€ï¼** âœ¨

